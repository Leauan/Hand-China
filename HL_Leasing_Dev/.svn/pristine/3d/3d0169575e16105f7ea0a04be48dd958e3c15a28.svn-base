<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: Hand Technology Consultant  
    $Date: 2015-4-1 上午9:43:29  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:c="aurora.application.action" xmlns:a="http://www.aurora-framework.org/application" xmlns:p="uncertain.proc" trace="true">
    <a:init-procedure>
        <a:model-query defaultWhereClause="sc.result_id = ${/parameter/@result_id}" model="fnd.FND714.fnd_sc_score_query" rootPath="fnd714_sc_score_query_path"/>
        <a:model-query model="fnd.FND714.fnd_sc_score_result_grade_from_to" rootPath="fnd714_sc_score_result_grade_from_to_path"/>
    </a:init-procedure>
    <a:view>
        <a:link id="prj_project_score_result_link_id" model="prj.PRJ902.prj_project_score_result" modelaction="execute"/>
        <a:link id="prj_project_evaluate_level_link_id" model="prj.PRJ902.prj_project_score_result" modelaction="update"/>
        <script><![CDATA[
            Aurora.onReady(function() {
                //获取评级结果
                //reset_evaluate_level(${/parameter/@result_id}, ${/model/fnd714_sc_score_query_path/record/@score_result});
            
                var expand_flag = '${/parameter/@expand_flag}';
                if (expand_flag == 'Y') {
                    return;
                } else if (expand_flag == 'N') {
                    Ext.get('gridButtonDivID').setStyle('display', 'none');
                    //Ext.get('fnd714_sc_score_result_dtl_grid').setStyle('display', 'none');
                }
            });
            
            function fnd714_sc_score_result_dtl_grid_render_name(value, record, name) {
                var target_score = record.get('target_score');
                if (record.get('summary_flag') == 'Y') {
                    return '';
                }
                if (name == record.get('target_score')) {
                    return '<font size="4" color="orange">★</font>';
                }
            }
            
            function fnd714_sc_score_result_dtl_render_score_value(value, record, name) {
                if (record.get('summary_flag') == 'Y') {
                    return '';
                }
                return value;
            }
            
            function fnd714_sc_score_result_dtl_render_target_score(value, record, name) {
                if (record.get('summary_flag') == 'Y') {
                    return '';
                }
                return value;
            }
            
            function fnd714_sc_score_result_dtl_render_target_score_sum(value, record, name) {
                var target_score = record.get('target_score');
                if (record.get('display_flag') == 'Y' && record.get('summary_flag') == 'Y' && $('fnd714_sc_score_head_query_ds').getCurrentRecord().get('template_type') == 'PD') {
                    return '<font color=red>'+ Aurora.formatNumber(target_score, 2) + '</font>';
                } else if (record.get('display_flag') == 'Y' && record.get('summary_flag') == 'Y' && $('fnd714_sc_score_head_query_ds').getCurrentRecord().get('template_type') == 'LGD') {
                    return '<font color=red>'+ Aurora.formatNumber(target_score, 2) + '</font>';
                }
                return '';
            }
            
            function fnd714_sc_score_result_dtl_grid_editorFunc(record, name) {
                if (name == 'target_score') { //行业分析  BAOXIN2-1-5   公司性质  BAOXIN2-1-1
                    if (record.get('score_target_code') == 'BAOXIN2-1-5' || record.get('score_target_code') == 'BAOXIN2-1-1') {
                        if ('${/parameter/@expand_flag}' == 'Y') {
                            return 'fnd714_sc_score_result_dtl_grid_nf';
                        } else {
                            return '';
                        }
                    }
                }
                return '';
            }
            
            function reset_evaluate_level(result_id, score_result) {
                /* Aurora.Masker.mask(Ext.getBody(), '正在获取评级结果');
                //获取评级结果
                Aurora.request({
                    url: $('prj_project_evaluate_level_link_id').getUrl(),
                    para: {
                        result_id: result_id,
                        score_result: score_result
                    },
                    success: function(res) {debugger;
                        var evaluate_level = res.result.evaluate_level;
                        $('prj_project_evaluate_level_ds').getAt(0).set('evaluate_level', evaluate_level);
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    error: function() {
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    failure: function() {
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    sync: true,
                    scope: this
                }); */
            }
            
            function target_score_update(ds, record, name, value, oldvalue) {
                if (name == 'target_score') {
                    var target_score = record.get('target_score');
                    record.set('target_score', target_score);
                    record.set('target_score_original', target_score);
            
                    //行业分析  BAOXIN2-1-5   公司性质  BAOXIN2-1-1 计算对应上级分数和总分数
                    if (record.get('score_target_code') == 'BAOXIN2-1-5' || record.get('score_target_code') == 'BAOXIN2-1-1') {
                        var records = ds.getAll();
                        for (var i = 0;i < records.length;i++) {
                            //稳定性:78分
                            if (records[i].get('score_target_code') == 'BAOXIN2-1') {
                                var target_score_tmp = records[i].get('target_score');
                                target_score_tmp = target_score_tmp + value - oldvalue;
                                records[i].set('target_score', target_score_tmp);
                                records[i].set('target_score', target_score_tmp);
                            }
                        }
                        var sc_score_head_record = $('fnd714_sc_score_head_query_ds').getAt(0);
                        var score_result = sc_score_head_record.get('score_result') + value - oldvalue;
                        sc_score_head_record.set('score_result', score_result);
            
                        reset_evaluate_level(${/parameter/@result_id}, score_result);
                    }
                }
            }
            
            function fnd714_sc_score_result_save() {
                $('fnd714_sc_score_head_query_ds').submit();
            }
            
            function score_head_submitsuccess() {
                $('fnd714_sc_score_head_query_ds').query();
                //$('fnd714_sc_score_result_dtl_ds').query();
            }
            
            function score_head_beforesubmit(ds) {
                var records = $('fnd714_sc_score_result_dtl_ds').getAll();
                for (var i = 0;i < records.length;i++) {
                    var record = records[i];
                    var target_value = record.get('target_value');
                    var score_target_code = record.get('score_target_code');
                    var target_score = record.get('target_score');
                    if (score_target_code == 'BAOXIN2-1-1') { //公司性质
                        if (target_value == 'STATE_OWNED_ENTERPRISE') { //央、国企   10
                            if (target_score != 10) {
                                Aurora.showMessage('${l:PROMPT}', '公司性质为央、国企时只能为10');
                                return false;
                            }
                        } else if (target_value == 'LISTING_CORPORATION') { //上市公司  6-10
                            if (target_score > 10 || target_score < 6) {
                                Aurora.showMessage('${l:PROMPT}', '公司性质为上市公司时只能为6-10');
                                return false;
                            }
                        } else if (target_value == 'FOREIGN_FN_ENT_INCLUD_HK_MACAO') { //外资企业(含港澳台) 2-8
                            if (target_score > 8 || target_score < 2) {
                                Aurora.showMessage('${l:PROMPT}', '公司性质为外资企业(含港澳台)时只能为2-8');
                                return false;
                            }
                        } else if (target_value == 'SINO_FOREIGN_JOINT_VENTURE') { //中外合资 0-8
                            if (target_score > 8 || target_score < 0) {
                                Aurora.showMessage('${l:PROMPT}', '公司性质为中外合资时只能为0-8');
                                return false;
                            }
                        } else if (target_value == 'PRIVATE_ENTERPRISE') { //私营企业 0-8
                            if (target_score > 8 || target_score < 2) {
                                Aurora.showMessage('${l:PROMPT}', '公司性质为私营企业时只能为0-8');
                                return false;
                            }
                        }
                    }
                    if (score_target_code == 'BAOXIN2-1-5') { //行业分析
                        if (target_value == 'ORGANIZATION') { //机构组织   20-30
                            if (target_score > 30 || target_score < 20) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为机构组织时只能为20-30');
                                return false;
                            }
                        } else if (target_value == 'FINANCIAL_AND_INTERNET_INFO') { //金融及互联网信息 0-30
                            if (target_score > 30 || target_score < 0) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为金融及互联网信息时只能为0-30');
                                return false;
                            }
                        } else if (target_value == 'WHOLESALE_AND_RETAIL_INDUSTRY') { //制造业及零售批发 5-25
                            if (target_score > 25 || target_score < 5) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为制造业及零售批发时只能为5-25');
                                return false;
                            }
                        } else if (target_value == 'LOGISTICS_AND_CATERING_TRADE') { //物流贸易及餐饮  0-25
                            if (target_score > 25 || target_score < 0) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为物流贸易及餐饮时只能为0-25');
                                return false;
                            }
                        } else if (target_value == 'CONSTRUCTION_AND_ELECTRICAL') { //建筑工程及机械机电  0-20
                            if (target_score > 20 || target_score < 0) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为物流贸易及餐饮时只能为0-20');
                                return false;
                            }
                        } else if (target_value == 'OTHERS') { //其他  0-30
                            if (target_score > 30 || target_score < 0) {
                                Aurora.showMessage('${l:PROMPT}', '行业分析为其他时只能为0-30');
                                return false;
                            }
                        }
                    }
                }
            }
            
            function fnd714_sc_score_result_recalc() {
                Aurora.Masker.mask(Ext.getBody(), '${l:HLS.EXECUTING}');
                Aurora.request({
                    url: $('prj_project_score_result_link_id').getUrl(),
                    para: {
                        project_id: '${/parameter/@project_id}',
                        score_num: '${/parameter/@score_num}',
                        recalc_flag: 'Y'
                    },
                    success: function(res) {
                        $('fnd714_sc_score_head_query_ds').query();
                        //$('fnd714_sc_score_result_dtl_ds').query();
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    error: function() {
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    failure: function() {
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    sync: true,
                    scope: this
                });
            }
            
            function score_head_load(ds){
                //获取评级结果
                var score_result = $('fnd714_sc_score_head_query_ds').getAt(0).get('score_result');debugger;
                reset_evaluate_level(${/parameter/@result_id}, score_result);
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="prj_project_evaluate_level_ds" autoCreate="true">
                <a:fields>
                    <a:field name="evaluate_level"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="fnd714_sc_score_head_query_ds" model="fnd.FND714.fnd_sc_score_query" queryUrl="${/request/@context_path}/autocrud/fnd.FND714.fnd_sc_score_query/query?result_id = ${/parameter/@result_id}&amp;sc_score_id=${/parameter/@sc_score_id}" submitUrl="${/request/@context_path}/modules/prj/PRJ902/prj_project_score_result_dtl.svc">
                <a:datas dataSource="/model/fnd714_sc_score_query_path"/>
                <a:events>
                    <a:event name="submitsuccess" handler="score_head_submitsuccess"/>
                    <a:event name="beforesubmit" handler="score_head_beforesubmit"/>
                    <a:event name="load" handler="score_head_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="fnd714_sc_score_result_dtl_ds" bindName="result_dtl" bindTarget="fnd714_sc_score_head_query_ds" fetchAll="true" loadData="true" model="fnd.FND714.fnd_sc_score_result_dtl_query" queryUrl="${/request/@context_path}/autocrud/fnd.FND714.fnd_sc_score_result_dtl_query/query?template_type=${/parameter/@template_type}&amp;expand_flag=${/parameter/@expand_flag}">
                <a:fields>
                    <a:field name="target_score" lovGridHeight="350" lovHeight="550" lovWidth="500" title="评级">
                        <a:mapping>
                            <a:map from="score_value" to="target_score"/>
                            <a:map from="score_value" to="target_value"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="target_value"/>
                    <a:field name="target_score_original"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="target_score_update"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <div id="gridButtonDivID">
                <a:screenTopToolbar>
                    <a:screenTitle/>
                    <!-- <a:gridButton click="fnd714_sc_score_result_save" text="HLS.SAVE"/> -->
                    <!-- <a:gridButton click="fnd714_sc_score_result_recalc" text="重算"/> -->
                </a:screenTopToolbar>
            </div>
            <a:hBox>
                <a:vBox labelSeparator=" " labelWidth="100">
                    <!-- <a:textField name="template_type_desc" bindTarget="fnd714_sc_score_head_query_ds" prompt="FND713.FND_SCORE_TEMPLATE.TEMPLATE_TYPE" readOnly="true"/> -->
                    <a:textField name="evaluate_level" bindTarget="prj_project_evaluate_level_ds" prompt="评级" readOnly="true"/>
                    <a:numberField name="score_result" allowDecimals="true" bindTarget="fnd714_sc_score_head_query_ds" decimalPrecision="2" prompt="分数" readOnly="true" style="font-weight:bold"/>
                </a:vBox>
                <a:vBox labelSeparator=" " labelWidth="100">
                    <a:textField name="object_name" bindTarget="fnd714_sc_score_head_query_ds" prompt="承租人名称" readOnly="true"/>
                    <a:textField name="last_update_name" bindTarget="fnd714_sc_score_head_query_ds" prompt="FND714.LAST_UPDATE_NAME" readOnly="true"/>
                </a:vBox>
                <a:vBox labelSeparator=" " labelWidth="100">
                    <a:textField name="template_name" bindTarget="fnd714_sc_score_head_query_ds" prompt="FND714.SCORE_TEMPLATE_NAME" readOnly="true"/>
                    <a:datePicker name="score_date" bindTarget="fnd714_sc_score_head_query_ds" prompt="FND714.SCORE_DATE" readOnly="true" renderer="Aurora.formatDate"/>
                </a:vBox>
            </a:hBox>
            <a:treeGrid id="fnd714_sc_score_result_dtl_grid" bindTarget="fnd714_sc_score_result_dtl_ds" expandField="expand_flag" idField="tree_id_feild" marginHeight="180" marginWidth="30" navBar="false" parentField="tree_parent_field" sequenceField="score_target_code">
                <a:columns>
                    <a:column name="score_target_name" prompt="FND714.SCORE_TARGET_NAME" width="250"/>
                    <!-- <a:column name="target_value" prompt="指标值" width="150"/> -->
                    <a:column name="target_value_name" prompt="指标值" width="250"/>
                    <!-- <a:column name="score_value" prompt="权重" renderer="fnd714_sc_score_result_dtl_render_score_value" width="80"/> -->
                    <!-- <a:column name="target_score" editorFunction="fnd714_sc_score_result_dtl_grid_editorFunc" prompt="FND714.TARGET_SCORE" renderer="fnd714_sc_score_result_dtl_render_target_score"/> -->
                    <a:column name="target_score" prompt="得分" renderer="fnd714_sc_score_result_dtl_render_target_score" width="80"/>
                    <a:placeHolder id="fnd714_dynamicColumns"/>
                    <a:column name="target_score_sum" prompt="小计" renderer="fnd714_sc_score_result_dtl_render_target_score_sum" width="80"/>
                </a:columns>
                <a:editors>
                    <a:numberField id="fnd714_sc_score_result_dtl_grid_nf"/>
                </a:editors>
            </a:treeGrid>
        </a:screenBody>
    </a:view>
    <a:view-config>
        <c:create-config targetId="fnd714_dynamicColumns">
            <p:loop source="/model/fnd714_sc_score_result_grade_from_to_path">
                <c:process-config>
                    <a:column name="${@line_number}" align="center" prompt="${@sc_scaleplate_code}" renderer="fnd714_sc_score_result_dtl_grid_render_name" width="60"/>
                </c:process-config>
            </p:loop>
        </c:create-config>
    </a:view-config>
</a:screen>
