<?xml version="1.0" encoding="UTF-8"?>
<a:service xmlns:ns1="aurora.application.action" xmlns:p="uncertain.proc" xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <s:server-script import="app/app_login_check.js"><![CDATA[
            function lov_query() {
                var app_contract_details;
                var contract_details;
                var con_lease_details;
                var con_cdd_list_details;
                try {
                    var app_contract_view_list_bm = $bm('app.lov.app_contract_view_list');
                    var contract_bm = $bm('app.lov.app_contract_info');
                    var con_lease_bm = $bm('app.lov.app_leases_info');
                    var con_cdd_list_bm = $bm('app.lov.app_con_cdd');
            
                    var contract_map = contract_bm.queryAsMap({
                        'contract_id': $ctx.parameter.contract_id
                    });
                    var con_lease_map = con_lease_bm.queryAsMap({
                        'contract_id': $ctx.parameter.contract_id
                    });
                    var app_contract_view_list_map = app_contract_view_list_bm.queryAsMap({
                        'contract_id': $ctx.parameter.contract_id
                    });
                    var con_cdd_list_bm_map = con_cdd_list_bm.queryAsMap({
                        'contract_id': $ctx.parameter.contract_id
                    });
                    app_contract_details = app_contract_view_list_map.getChildren();
                    contract_details = contract_map.getChildren();
                    con_lease_details = con_lease_map.getChildren();
                    con_cdd_list_details = con_cdd_list_bm_map.getChildren();
                    $ctx.parameter.return_status = 'S';
                    $ctx.parameter.return_message = '执行成功';
                } catch (e) {
                    $ctx.success = "true";
                    $ctx.parameter.return_status = 'E';
                    $ctx.parameter.return_message = String(e);
                }
            
            
                var result = {
                    result: $ctx.parameter.return_status,
                    message: $ctx.parameter.return_message,
                    app_contract_list: [],
                    contract_list: [],
                    con_lease_list: [],
                    con_cdd_list: []
                };
            
                var app_contract_list = result.app_contract_list;
                var contract_list = result.contract_list;
                var con_lease_list = result.con_lease_list;
                var con_cdd_list = result.con_cdd_list;
            
                if (app_contract_details) {
                    for (var j = 0;j < app_contract_details.length;j++) {
                        var app_contract_detail = app_contract_details[j];
                        app_contract_list.push({
                            "contract_id": app_contract_detail.contract_id,
                            "contract_number": app_contract_detail.contract_number,
                            "project_number": app_contract_detail.project_number,
                            "bp_id_tenant_n": app_contract_detail.bp_id_tenant_n,
                            "id_card_no": app_contract_detail.id_card_no
                        });
                    }
                }
                if (contract_details) {
                    for (var j = 0;j < contract_details.length;j++) {
                        var contract_detail = contract_details[j];
                        contract_list.push({
                            "finance_amount": contract_detail.finance_amount,
                            "total_rental": contract_detail.total_rental,
                            "lease_times": contract_detail.lease_times,
                            "bank_name": contract_detail.bank_name,
                            "dd_bank_account_name": contract_detail.dd_bank_account_name,
                            "dd_bank_account_num": contract_detail.dd_bank_account_num
                        });
                    }
                }
                if (con_lease_details) {
                    for (var m = 0;m < con_lease_details.length;m++) {
                        var con_lease_detail = con_lease_details[m];
                        con_lease_list.push({
                            "brand_id_n": con_lease_detail.brand_id_n,
                            "ms_info": con_lease_detail.ms_info,
                            "color_of_apprearance": con_lease_detail.color_of_apprearance,
                            "item_frame_number": con_lease_detail.item_frame_number,
                            "item_engine_number": con_lease_detail.item_engine_number,
                            "license_number": con_lease_detail.license_number
                        });
                    }
                }
                if (con_cdd_list_details) {
                    for (var m = 0;m < con_cdd_list_details.length;m++) {
                        var con_cdd_list_detail = con_cdd_list_details[m];
                        con_cdd_list.push({
                            "cdd_item": con_cdd_list_detail.cdd_item,
                            "cdd_item_id": con_cdd_list_detail.cdd_item_id,
                            "check_id": con_cdd_list_detail.check_id,
                            "cdd_item_desc": con_cdd_list_detail.cdd_item_desc,
                            "atm_num": con_cdd_list_detail.atm_num
                        });
                    }
                }
                $ctx.parameter.json = JSON.stringify(result);
            }
            
            if ($ctx.parameter.return_status != 'E' && $ctx.parameter.return_status != 'TIMEOUT') {
                lov_query();
            }
        ]]></s:server-script>
    </a:init-procedure>
    <a:service-output output="/parameter/@json"/>
</a:service>
