<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: qm  
    $Date: 2014-4-21 上午10:14:25  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure/>
    <a:view>
        <a:link id="insurance_attachment_uploadFileIns_id" url="${/request/@context_path}/modules/ast/AST503/uploadFileIns.screen"/>
        <a:link id="insurance_attachment_downloadFileIns_id" url="${/request/@context_path}/modules/ast/AST503/downloadFileIns.screen"/>
        <a:link id="insurance_endorse_link_id" url="${/request/@context_path}/modules/cont/CON762/con_insurance_endorse_change.screen"/>
        <a:link id="ast_con_insurance_window_link" url="${/request/@context_path}/modules/ast/AST503/ast_con_insurance_detail.screen"/>
        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
        <a:link id="license_attachment_uploadFile_id" url="${/request/@context_path}/uploadFile.screen"/>
        <script><![CDATA[
     
            function submitsuccess() {
                $('ast_car_mortgage_result_ds').query();
            }
            // result_ds.setSubmitParameter('base_rate_set','${/parameter/@base_rate_set}');
            // function insuranceSelectHandler(ds, record) {
                      
                // var record2 = $(ds.id).getCurrentRecord();
                // // alert(ds.id + '   '  + record2.get('contract_id'));
                // if (  record2.get('con_mortgage_id')) {
                   
                    // $('ast_car_mortgage_records_ds').setQueryParameter('con_mortgage_id', record2.get('con_mortgage_id'));
                    
                    // $('ast_car_mortgage_records_ds').query();
                // }
            // }
            
             function insuranceSelectHandler(ds, rec) {
                if ( !! rec.get('con_mortgage_id')) {
                    $('ast_car_mortgage_records_ds').setQueryParameter('con_mortgage_id', rec.get('con_mortgage_id'));
                    $('ast_car_mortgage_records_ds').query();
                }
            }
            
           
            
            // function receipt_attachment_upload(val, rec, name) {
                // //return '<a href=javascript:open_upload_window(' + rec.get('con_mortgage_id') + ')>附件上传</a>';
                // return '<a href=javascript:open_upload_window(' + rec.id + ')>附件上传</a>';
            // }
              function receipt_attachment_upload(val, rec, name) {
                return '<a href=javascript:open_upload_window(' + rec.get('con_mortgage_id') + ')>附件上传</a>';
            }
            
              function attachment_upload(val, rec, name) {
                //return '<a href=javascript:detail_upload_window(' + rec.get('ast_car_insurance_records_id') + ')>附件上传</a>';
                return '<a href=javascript:detail_upload_window(' + rec.id + ')>附件上传</a>';
            }
            
             function open_upload_window(record_id) {
                if (Aurora.isEmpty(record_id)) {
                    Aurora.showMessage('提示', '请先保存再上传附件！');
                    return;
                }
                var url = $('license_attachment_uploadFile_id').getUrl() + '?table_name=CON_CONTRACT_MORTGAGE&header_id=' + record_id;
                var win = new Aurora.Window({
                    url: url,
                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
                    id: 'license_uploadFile_id',
                    width: 850,
                    height: 400
                });
                win.on('close', function() {});
            }
            

            function detail_upload_window(record_id) {
            
                var record = $('ast_car_mortgage_records_ds').findById(record_id);
                var record_id = record.get('con_mortgage_id');
                if (Aurora.isEmpty(record_id)) {
                    Aurora.showMessage('提示', '请先保存再上传附件！');
                    return;
                }
                var document_status = record.get('document_status');
                var url;
                if (document_status == 'NEW' || document_status == 'REJECTED' || document_status == 'CANCEL') {
                    url = $('insurance_attachment_uploadFileIns_id').getUrl() + '?table_name=mortgage_register_no&header_id=' + record_id;
                } else {
                    url = $('insurance_attachment_downloadFileIns_id').getUrl() + '?table_name=mortgage_register_no&header_id=' + record_id;
                }                                                                                         
                var win = new Aurora.Window({
                    url: url,
                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
                    id: 'insurance_records_uploadFile_id',
                    width: 850,
                    height: 400
                });
                win.on('close', function() {});
            }
            
           
            function commercial_renderer(val, rec, name) {
                if (rec.get('commercial_insurance_amount') == null || rec.get('commercial_insurance_amount') == '') {
                    rec.getField('combustion_rebate_rate').setReadOnly(true);
                } else {
                    rec.getField('combustion_rebate_rate').setReadOnly(false);
                }
                return Aurora.formatMoney(val);
            }
            
            function compulsory_renderer(val, rec, name) {
                if (rec.get('compulsory_insurance_amount') == null || rec.get('compulsory_insurance_amount') == '') {
                    rec.getField('compulsory_rebate_rate').setReadOnly(true);
                } else {
                    rec.getField('compulsory_rebate_rate').setReadOnly(false);
                }
                return Aurora.formatMoney(val);
            }
  
            function check_insurance_type(record, name) {             
                if (name == 'value' || name == 'mortgage_register_fee') {
                    return 'ast_car_insurance_nf';
                }
                return '';
            }
            //批单更改
 
            function insurance_endorse(val, rec, name) {
                return '<a href=javascript:open_insurance_endorse_window(' + rec.get('ast_car_insurance_id') + ')>批单更改</a>';
            }           
            function open_insurance_endorse_window(record_id) {
                var url = $('insurance_endorse_link_id').getUrl();
                var win = new Aurora.Window({
                    id: 'con_insurance_endorse_win',
                    url: url,
                    params: {
                        ast_car_insurance_id: record_id,
                        winId: 'con_insurance_endorse_win'
                    },
                    width: 720,
                    height: 400
                });            
            }

            function open_ast_con_insurance_window(con_mortgage_id) {
                var record = $('ast_car_mortgage_result_ds').getCurrentRecord();
                var document_status = record.get('document_status');
                if (record.dirty) {
                    Aurora.showMessage('${l:PROMPT}', '数据存在更新，请先保存');
                } else {
                    var param = {};
                    param['con_mortgage_id'] = con_mortgage_id;
                    if (document_status == 'NEW' || document_status == 'CANCEL' || document_status == 'REJECTED') {
                        param['function_code'] = 'AST503D';
                    } else {
                        param['function_code'] = 'AST503Q';
                    }
                    param['function_usage'] = 'MODIFY';
                    param['maintain_type'] = 'UPDATE';
                    param['url_title'] = '保险明细';
                    param['winid'] = 'ast_con_insurance_window_link_winid';
                    hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'ast_con_insurance_window_link', 'ast_car_mortgage_result_ds');
                }
            }
            
            function ast_car_insurance_load(ds) {
                
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var document_status = records[i].get('document_status');
                    if (document_status == 'APPROVED' || document_status == 'APPROVING' || document_status == 'CANCEL' || Ext.isEmpty(document_status)) { 
                         records[i].getField('mortgage_register_no').setReadOnly(true);
                          records[i].getField('mortgage_register_date').setReadOnly(true);
                           records[i].getField('mortgage_name').setReadOnly(true);
                            records[i].getField('value').setReadOnly(true);
                             records[i].getField('mortgage_register_fee').setReadOnly(true);
                              records[i].getField('mortgage_power_name').setReadOnly(true);
                                 records[i].getField('mortgagor_name').setReadOnly(true);
                               records[i].getField('remark').setReadOnly(true);                              
                    }
                }
            }
            function ast_car_insurance_records_load(ds) {
             
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var document_status = records[i].get('document_status');
                    if (document_status == 'APPROVED' || document_status == 'APPROVING' || Ext.isEmpty(document_status)) {
                        records[i].getField('mortgage_register_no').setReadOnly(true);
                        records[i].getField('mortgage_register_undo_date').setReadOnly(true);
                        records[i].getField('remark').setReadOnly(true);
                    }
                }
            }
            // function ast_car_insurance_delete() {
                // var records = $('ast_car_mortgage_result_ds').getCurrentRecord();
                // var document_status = records.get('document_status');
                // if (document_status == 'NEW' || document_status == 'REJECTED' || document_status == 'document_status') {
                    // $('ast_car_mortgage_result_ds').remove(records);
                // } else {
                    // Aurora.showMessage('提示', '文件已审批或在审批中不能删除！');
                // }
            // }
            
            // function ast_car_insurance_records_delete() {
                // var records = $('ast_car_mortgage_records_ds').getCurrentRecord();
                // var document_status = records.get('document_status');
                // if (document_status == 'NEW' || document_status == 'REJECTED' || document_status == 'document_status') {
                    // $('ast_car_mortgage_records_ds').remove(records);
                // } else {
                    // Aurora.showMessage('提示', '文件已审批或在审批中不能删除！');
                // }
            // }
        ]]></script>
        <a:dataSets>
            <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
            <a:dataSet id="ast_car_mortgage_result_ds" model="ast.AST507.ast_con_insurance_mortgage" selectable="true" selectionModel="single" submitUrl="${/request/@context_path}/modules/ast/AST507/ast_car_insurance_save_mortgage.svc">
                <a:fields>
                    <a:field name="con_mortgage_id"/>
                    <a:field name="contract_id"/>
                    <a:field name="mortgage_register_no" required="true"/>
                    <a:field name="mortgage_register_date" datatype="java.sql.date"/>
                    <a:field name="mortgage_name"/>
                    <a:field name="value"/>
                    <a:field name="mortgage_register_fee"/>
                    <a:field name="location"/>
                    <a:field name="mortgage_power_name"/>
                    <a:field name="mortgagor_name"/>
                </a:fields>
                <a:events>
                    <!--   <a:event name="update" handler="insuranceUpdateHandler"/> -->
                    <a:event name="select" handler="insuranceSelectHandler"/>
                    <a:event name="submitsuccess" handler="submitsuccess"/>
                    <a:event name="load" handler="ast_car_insurance_load"/>
                </a:events>
            </a:dataSet>
            <!-- queryUrl="${/request/@context_path}/autocrud/ast.AST501.ast_car_insurance_records" -->
            <a:dataSet id="ast_car_mortgage_records_ds" bindName="records_info" bindTarget="ast_car_mortgage_result_ds" model="ast.AST507.ast_con_insurance_undo_mortgage" selectable="true" selectionModel="single">
                <a:fields>
                    <a:field name="contract_id"/>
                    <a:field name="con_mortgage_record_id"/>
                    <a:field name="mortgage_register_no"/>
                    <a:field name="mortgage_register_undo_date" datatype="java.sql.date"/>
                    <a:field name="remark"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="ast_car_insurance_records_load"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:hBox height="5"/>
        <a:grid id="ast_car_insurance_grid_id" bindTarget="ast_car_mortgage_result_ds" height="165" marginWidth="50" navBar="true">
            <a:toolBar>
                <a:button text="抵押登记信息"/>
                <a:button type="add"/>
                <!--   <a:button click="ast_car_insurance_delete" icon="${/request/@context_path}/images/remove.gif" iconAlign="left" text="删除" width="50"/> -->
                <a:button type="delete"/>
            </a:toolBar>
            <a:columns>
                <a:column name="mortgage_register_no" editor="ast_car_insurance_tf" prompt="抵押登记证号" width="100"/>
                <a:column name="mortgage_register_date" editor="ast_car_insurance_dp" prompt="抵押登记日期" renderer="Aurora.formatDate" width="100"/>
                <a:column name="mortgage_name" align="right" editor="ast_car_insurance_tf" prompt="抵押物描述"/>
                <a:column name="value" editor="ast_car_insurance_nf" prompt="抵押物价值" renderer="Aurora.formatMoney"/>
                <a:column name="mortgage_register_fee" editor="ast_car_insurance_nf" prompt="抵押登记费用" renderer="Aurora.formatMoney"/>
                <a:column name="location" align="right" editor="ast_car_insurance_tf" prompt="抵押登记地"/>
                <a:column name="mortgage_power_name" align="right" editor="ast_car_insurance_tf" prompt="抵押权人" width="100"/>
                <a:column name="mortgagor_name" align="right" editor="ast_car_insurance_tf" prompt="抵押人" width="100"/>
                <a:column name="remark" align="right" editor="ast_car_insurance_tf" prompt="备注" width="100"/>
                <a:column name="center" prompt="附件" renderer="receipt_attachment_upload" width="80"/>
            </a:columns>
            <a:editors>
                <a:lov id="ast_car_insurance_lov"/>
                <a:datePicker id="ast_car_insurance_dp"/>
                <a:numberField id="ast_car_insurance_nf"/>
                <a:textField id="ast_car_insurance_tf"/>
                <a:checkBox id="ast_car_insurance_cb"/>
                <a:comboBox id="ast_car_insurance_combox"/>
            </a:editors>
        </a:grid>
        <a:hBox height="10"/>
        <a:grid id="con_mortgage_record_id" bindTarget="ast_car_mortgage_records_ds" height="165" marginWidth="50" navBar="true">
            <a:toolBar>
                <a:button text="解抵押登记信息"/>
                <a:button id="btn_ref_add" type="add"/>
                <a:button id="btn_ref_del" type="delete"/>
                <!--   <a:button click="ast_car_insurance_records_delete" icon="${/request/@context_path}/images/remove.gif" iconAlign="left" text="删除" width="50"/> -->
            </a:toolBar>
            <a:columns>
                <a:column name="mortgage_register_no" editor="edit_tf" prompt="抵押登记证号" width="120"/>
                <a:column name="mortgage_register_undo_date" editor="edit_dp" prompt="解抵押登记日期" renderer="Aurora.formatDate" width="120"/>
                <a:column name="remark" editor="edit_tf" prompt="备注"/>
                <a:column align="center" prompt="附件" renderer="attachment_upload" width="80"/>
            </a:columns>
            <a:editors>
                <a:textField id="edit_tf"/>
                <a:datePicker id="edit_dp"/>
            </a:editors>
        </a:grid>
    </a:view>
</a:screen>
