<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure><![CDATA[
    ]]></a:init-procedure>
    <a:view>
        <a:link id="con660_submit_wfl_link" model="cont.CON660.cancel_con_redemption" modelaction="execute"/>
        <a:link id="con660_cancel_con_redemption_link" model="cont.CON660.cancel_con_redemption" modelaction="update"/>
        <script><![CDATA[
            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_redemption_certificate');
                var record = $(ds_id).getAt(0);
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认取消申请？', function() {
                    Aurora.Masker.mask(Ext.getBody());
                    Aurora.request({
                        url: $('con660_cancel_con_redemption_link').getUrl(),
                        para: {
                            batch_id: record.get('batch_id')
                        },
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
                            $('${/parameter/@winid}').close();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }, null);
            };
            window['${/parameter/@layout_code}_submit_approval_layout_dynamic_click'] = function() {
                var con_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                var records = $(con_ds_id).getAll();
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_redemption_certificate');
                var record = $(ds_id).getAt(0);
                for (var i = 0;i < records.length;i++) {
                    var record_d = records[i];
                    if (record_d.dirty||!record_d.get('sz_to_date')||!record_d.get('sz_address')) {
                       var check_save =true;
                    }
                }
                if(check_save){
                        Aurora.showInfoMessage('提示', '请先保存！');
                        return false;
                }
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认提交申请？', function() {
                    Aurora.Masker.mask(Ext.getBody());
                    Aurora.request({
                        url: $('con660_submit_wfl_link').getUrl(),
                        para: {
                            batch_id: record.get('batch_id')
                        },
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
                            $('${/parameter/@winid}').close();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }, null);
            };
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
