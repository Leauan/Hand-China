<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: wangwei5743  
    $Date: 2014-10-8 下午3:16:19  
    $Revision: 1.0  
    $purpose: 租赁申请创建  创建界面       
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure>
        <a:model-query defaultWhereClause="t1.user_id=${/session/@user_id}" model="prj.PRJ500D.sys_user_lv" rootPath="user_name_path"/>
        <a:model-query fetchAll="true" model="prj.PRJ500D.sys_date" rootPath="sysdate"/>
    </a:init-procedure>
    <a:view>
	    <a:link id="${/parameter/@layout_code}_prj500_cdd_downloadFile_id" url="${/request/@context_path}/uploadOnlyFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}zj_wfl_approve_history_check" url="${/request/@context_path}/modules/zjwfl/zj_wfl_approve_history_check.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_car_organization_id" model="prj.PRJ500D.yonda_car_organization" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_special_fields_link_id" model="cont.CON500.con_contract_get_special_fields" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_calc_id" model="prj.PRJ500D.calc_quotation" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}check_product_package_bag_link_id" model="prj.PRJ500D.prj_project_before_workflow_start" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}submit_approval_link" model="prj.PRJ500D.prj_project_workflow_start" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_info_id" model="prj.PRJ500D.hls_bp_master_np_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_organization_code_id" model="prj.PRJ500D.hls_bp_master_org_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_info_guar_id" model="prj.PRJ500D.hls_bp_master_np_guar" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_org_code_info_guar_id" model="prj.PRJ500D.hls_bp_master_org_guar" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_tenant_sec_id" model="prj.PRJ500D.hls_bp_master_np_tenant_sec_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}user_id_query_link" model="prj.PRJ500D.sys_user_lv" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_calc_validate_sql_link" model="prj.PRJ500D.prj_get_calc_validate_sql" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_car_organization_id_link" model="prj.PRJ500D.get_hls_car_organization" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_company_distrct_link" model="prj.PRJ500D.get_company_info" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_bp_id_invoice_link" model="prj.PRJ500D.get_bp_id_invoice" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_atch_download_link" url="${/request/@context_path}/modules/batch_download/lease_atm_batch_dl.svc"/>
        <script src="${/request/@context_path}/modules/prj/PRJ500N/javascripts/input_validator.js"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}con_item_frame_number_link" model="cont.CON501N.con_item_frame_number" modelaction="execute"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj501n_analyse_detail_link" url="${/request/@context_path}/modules/prj/PRJ501N/prj_analyse_detail.screen"/>
        <link href="${/request/@context_path}/css/lightbox.css" rel="stylesheet" type="text/css"/>
        <script src="${/request/@context_path}/javascripts/lightbox.js"/>
        <!-- <script src="${/request/@context_path}/modules/prj/PRJ500N/javascripts/check_org_code.js"/> -->
        <script><![CDATA[
            Ext.ux.Lightbox.register('a[ref=img]', true);
            //提交审批
            var submit_wfl_flag = 'N';
            
            //add by wdd 20180413
            var hl_prj_overrule_grid_length = 0;
            //end
            
            // //add 20180417 评分指标补充校验
            if ('${/parameter/@layout_code}' == 'PROJECT_WFL_NP_RM') {
                zjwfl5110_ApproveChecker_add('zjwfl5110_submit', function(type) {
                    // if (type == 'view_page') {
                    // var prj_project_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                    // //var prj_project_id = get_dsid_by_tabcode_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'T_SCORE_INDEX', 'prj_project');
                    // var prj_project_record = $(prj_project_id).getAt(0);
                    // var character_rm = prj_project_record.get('character_rm');
                    // var license_flag_rm = prj_project_record.get('license_flag_rm');
                    // var company_nature_rm = prj_project_record.get('company_nature_rm');
                    // var agent_recommend_rm = prj_project_record.get('agent_recommend_rm');
                    // if (character_rm && license_flag_rm && company_nature_rm && agent_recommend_rm) {
                    // submit_wfl_flag = 'Y';
                    // } else if (submit_wfl_flag != 'Y') {
                    // Aurora.showMessage('提示', '请先保存评分指标再评分！');
                    // return false;
                    // }
                    // }  //应要求 放开校验
                    if (type == 'agree') {
                        var prj_project_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                        var prj_project_bp_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
                        //var prj_project_id = get_dsid_by_tabcode_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'T_SCORE_INDEX', 'prj_project');
                        var prj_project_record = $(prj_project_id).getAt(0);
                        var character_rm = prj_project_record.get('character_rm');
                        var license_flag_rm = prj_project_record.get('license_flag_rm');
                        var company_nature_rm = prj_project_record.get('company_nature_rm');
                        var agent_recommend_rm = prj_project_record.get('agent_recommend_rm');
                        if (prj_project_record.dirty) {
                            Aurora.showMessage('提示', '评分指标存在修改，请保存！');
                            return false;
                        }
                        //if (Ext.isEmpty($(prj_project_bp_id).getAt(0).get('industry')) || Ext.isEmpty($(prj_project_bp_id).getAt(0).get('occuption'))) {
                            //Aurora.showMessage('提示', '行业和职业不能为空，请先填写并保存！');
                           // return false;
                       // }
                        if ($(prj_project_bp_id).getAt(0).dirty) {
                            Aurora.showMessage('提示', '页面数据存在修改，请先保存！');
                            return false;
                        }
                        var hl_prj_reject_reason_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hl_prj_reject_reason');
                        var reason_record = $(hl_prj_reject_reason_id).getAt(0);
                        if (reason_record.dirty) {
                            Aurora.showMessage('提示', '页面数据存在修改，请先保存！');
                            return false;
                        }
                        for (var i = 6;i > 0;i--) {
                            var reason_id_1 = 'first_reject_reason_' + i;
                            var reason_id_2 = 'second_reject_reason_' + i;
                            // alert(reason_record.get(reason_id_1));
                            // alert(reason_record.get(reason_id_2));
                            if (!Ext.isEmpty(reason_record.get(reason_id_1)) || !Ext.isEmpty(reason_record.get(reason_id_2))) {
                                Aurora.showMessage('提示', '存在拒绝原因，无法同意！');
                                return false;
                            }
                        }
                        // else if (character_rm == undefined || license_flag_rm == undefined || company_nature_rm == undefined || agent_recommend_rm == undefined) {
                        // Aurora.showMessage('提示', '请维护评分指标补充并保存！');
                        // return false;
                        // }  //应要求 放开校验
                    }
                    return true;
                });
            }
            
            //提交审批
            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
                window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认提交？', function() {
                    window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
                    var root_ds_1 = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds_1.validate()) {
                        submit_wfl_flag = 'Y';
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                    }
                });
            };
            //打包下载
            window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                var prj_project_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_project_record = $(prj_project_id).getAt(0);
                var project_id = prj_project_record.get('project_id');
                var url_l = $('${/parameter/@layout_code}${/parameter/@pre_layout}get_atch_download_link').getUrl() + '?table_pk_value=' + project_id + '&table_name=PRJ_PROJECT' + '&doc_code=' + project_id + '&all_flag=Y';
                window.open(href = url_l, target = "_self");
            };
            
            //单据跟踪
            window['${/parameter/@layout_code}_user_button3_layout_dynamic_click'] = function() {
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var instance_id = $(prj_project_ds_id).getAt(0).get('wfl_instance_id');
                var win = new Aurora.Window({
                    id: 'history_check',
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}zj_wfl_approve_history_check').getUrl(),
                    params: {
                        instance_id: instance_id
                    },
                    title: '单据历史查看',
                    height: 500,
                    width: 860,
                    fullScreen: true
                });
            };
            
            //打包下载
            window['${/parameter/@layout_code}_ACY_USER_BUTTON1_layout_dynamic_tab_click'] = function() {
                var prj_project_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_project_record = $(prj_project_id).getAt(0);
                var project_id = prj_project_record.get('project_id');
                var url_l = $('${/parameter/@layout_code}${/parameter/@pre_layout}get_atch_download_link').getUrl() + '?table_pk_value=' + project_id + '&table_name=PRJ_PROJECT' + '&doc_code=' + project_id + '&all_flag=Y';
                window.open(href = url_l, target = "_self");
            };
            
            //保存submitsuccess调用
            window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'] = function(ds, record, res) {
                // debugger;
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                //      alert($(ds_id).getAt(0).get('character_rm'));
                if (submit_wfl_flag == 'Y') {
                    submit_wfl_flag = 'N';
                    Aurora.request({
                        url: $('${/parameter/@layout_code}${/parameter/@pre_layout}submit_approval_link').getUrl(),
                        para: {
                            project_id: $(ds_id).getAt(0).get('project_id')
                        },
                        success: function() {
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            $('${/parameter/@winid}').close();
                            Aurora.SideBar.show({
                                msg: '操作成功',
                                duration: 2000
                            });
                        },
                        failure: function() {
                            submit_wfl_flag = 'N';
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        error: function() {
                            submit_wfl_flag = 'N';
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        scope: this
                    });
            
                } else {
                    if (ds_id) {
                        record = $(ds_id).getAt(0);
                        var cdd_item_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
                        $(cdd_item_ds_id).setQueryParameter('cdd_list_id', record.get('cdd_list_id'));
                        $(cdd_item_ds_id).query();
                        var prj_cdd_item_doc_ref_ds = $(cdd_item_ds_id);
            
                        function prj_cdd_item_doc_ref_load() {
                            //取消重复监听
                            prj_cdd_item_doc_ref_ds.un('load', prj_cdd_item_doc_ref_load);
                            $(cdd_item_ds_id).submit();
                        }
                        prj_cdd_item_doc_ref_ds.on('load', prj_cdd_item_doc_ref_load);
                        var ln_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_fin_calculator_ln');
                        var quotation_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_quotation');
                        $(ln_ds_id).query();
                        $(quotation_ds_id).query();
                    }
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                }
            
            
                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
            };
            
            function upload_file(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('check_id')) {
                    var url;
                    if (query_only == 'Y') {
					     url = $('${/parameter/@layout_code}_prj500_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                        //url = $('${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    } else {
                        url = $('${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: 'prj500_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
            
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            }
            
            function prj501_open_analyse_win(record_id, ds_id, condition_code) {
                var record = $(ds_id).findById(record_id);
                var param = {};
                param['target_type'] = record.get('target_type');
                param['target'] = record.get('target');
                param['condition_code'] = condition_code;
                param['layout_code'] = 'PRJ_ANALYSE_DETAIL';
                param['winid'] = 'prj501n_analyse_detail_win';
                param['function_usage'] = 'QUERY';
                var win = new Aurora.Window({
                    id: 'prj501n_analyse_detail_win',
                    params: param,
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}prj501n_analyse_detail_link').getUrl(),
                    title: '维度明细(' + 'PRJ_ANALYSE_DETAIL)',
                    fullScreen: true,
                    draggable: true
                });
            }
            //超链接渲染
            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
                var link_function = '';
                window['${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
                if (name == 'attachment') {
				     link_function = 'upload_file';
			       return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + 'Y' + '\');">' + config_record.get('prompt') + '</a>';
                   
                    //return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                } else if (name == 'attach_file_name') {
                    if (value != null) {
                        var link = '${/request/@context_path}/atm_download.svc?attachment_id=';
                        var str = value.split(';;');
                        var url = '';
                        for (var i = 0;i < str.length;i++) {
                            var temp = str[i].split('--');
                            if (!Aurora.isEmpty(temp[0])) {
                                //url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                var file_suffix = temp[0].substr(temp[0].lastIndexOf('.') + 1).toUpperCase();
                                if (file_suffix == 'BMP' || file_suffix == 'JPG' || file_suffix == 'JPEG' || file_suffix == 'PNG' || file_suffix == 'GIF') {
                                    url = url + '<a ref="img" href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                } else {
                                    url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                }
                            }
                        }
                        return url;
            
                    }
                } else if (name == 'description') {
                    if (record.get('important_flag') == 'Y') {
                        return '<font color="RED">' + value + '</font>';
                    }
                    return value;
                } else if (name == 'approved_count' || name == 'reject_count' || name == 'cancel_count' || name == 'terminate_count' || name == 'new_count') {
                    var condition_code;
                    if (name === 'approved_count') {
                        condition_code = '11';
                    } else if (name === 'reject_count') {
                        condition_code = '12';
                    } else if (name === 'cancel_count') {
                        condition_code = '13';
                    } else if (name === 'terminate_count') {
                        condition_code = '14';
                    }else if (name === 'new_count') {
                        condition_code = '15';
                    }
                    if (value > 0) {
                        return '<a href="javascript:prj501_open_analyse_win(\'' + record.id + '\',\'' + record.ds.id + '\',\'' + condition_code + '\')">' + value + '</a>';
                    } else {
                        return value;
                    }
            
                }
            }; /*查询前调用*/
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_record = $(prj_project_ds_id).getAt(0);
                qpara.project_id = prj_record.get('project_id');
            }; /*保存前调用，生成项目编号*/
            window['${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function(ds, record) {
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_record = $(prj_project_ds_id).getAt(0);
                var check_flag = false;
                if (prj_record.get('project_number')) {
                    return true;
                }
                Aurora.request({
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}get_special_fields_link_id').getUrl(),
                    para: {
                        document_category: '${/parameter/@document_category}',
                        document_type: record.get('document_type'),
                        function_code: '${/parameter/@function_code}',
                        function_usage: '${/parameter/@function_usage}'
                    },
                    success: function(res) {
                        var document_number = res.result.document_number;
                        prj_record.set('project_number', document_number);
                        check_flag = true;
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    error: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    failure: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    sync: true,
                    scope: this
                });
                return check_flag;
            
            };
            //新增和加载时调用form
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_form_add_and_load'] = function(ds, record, config_records, bp_seq) {
                //如果存在的话，进行校验逻辑  排除掉联系人校验
                if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                    //申请人身份证验证
                    if (ds.fields.id_card_no) {
                        ds.fields.id_card_no.pro.validator = id_card_no_validate;
                    }
                    //申请人手机验证
                    if (ds.fields.cell_phone) {
                        ds.fields.cell_phone.pro.validator = cell_phone_validate;
                    }
                    //申请人婚姻状况验证
                    if (ds.fields.marital_status) {
                        ds.fields.marital_status.pro.validator = marital_status_validate;
                        marital_status_validate(record, name, record.get('marital_status'));
                    }
                    //申请人配偶身份证校验
                    if (ds.fields.id_no_sp) {
                        ds.fields.id_no_sp.pro.validator = id_no_sp_validate;
                    }
                    //申请人配偶手机校验
                    if (ds.fields.cell_phone_sp) {
                        ds.fields.cell_phone_sp.pro.validator = cell_phone_sp_validate;
                    }
                }
                if ((ds.id).indexOf('prj_project_lease_item') != -1) {
                    //产品带出
                    if (ds.fields.product_plan_id_n) {
                        ds.fields.product_plan_id_n.pro.validator = product_plan_id_validate;
                    }
                    //期数校验
                    if (ds.fields.lease_times) {
                        ds.fields.lease_times.pro.validator = lease_times_validate;
                    }
                    //首付款比例校验
                    if (ds.fields.down_payment_ratio) {
                        ds.fields.down_payment_ratio.pro.validator = down_payment_ratio_validate;
                    }
                    //保证金比例校验
                    if (ds.fields.deposit_ratio) {
                        ds.fields.deposit_ratio.pro.validator = deposit_ratio_validate;
                    }
                    //保证金校验
                    if (ds.fields.deposit) {
                        ds.fields.deposit.pro.validator = deposit_validate;
                    }
                    //首付款校验
                    if (ds.fields.down_payment) {
                        ds.fields.down_payment.pro.validator = down_payment_validate;
                        down_payment_validate(record, name, record.get('down_payment'));
                    }
                    //购置价校验
                    if (ds.fields.invoice_price) {
                        ds.fields.invoice_price.pro.validator = invoice_price_validate;
                        invoice_price_validate(record, name, record.get('invoice_price'));
                    }
                    //融资额校验
                    if (ds.fields.finance_amount) {
                        ds.fields.finance_amount.pro.validator = finance_amount_validate;
                    }
                    //手续费校验
                    if (ds.fields.lease_charge) {
                        ds.fields.lease_charge.pro.validator = lease_charge_validate;
                    }
                    //上牌费校验
                    if (ds.fields.plate_price) {
                        ds.fields.plate_price.pro.validator = plate_price_validate;
                        plate_price_validate(record, name, record.get('plate_price'));
                    }
                    //购置税校验
                    if (ds.fields.purchase_tax) {
                        ds.fields.purchase_tax.pro.validator = purchase_tax_validate;
                        purchase_tax_validate(record, name, record.get('purchase_tax'));
                    }
                    //保险费校验
                    if (ds.fields.insurance_amount) {
                        ds.fields.insurance_amount.pro.validator = insurance_amount_validate;
                        insurance_amount_validate(record, name, record.get('insurance_amount'));
                    }
                    //指导价校验
                    if (ds.fields.guide_price) {
                        ds.fields.guide_price.pro.validator = guide_price_validate;
                    }
                }
                if ((ds.id).indexOf('prj_project_bp_contact_info' != -1)) {
                    //联系人1手机校验
                    if (ds.fields.phone_1) {
                        ds.fields.phone_1.pro.validator = phone_validate;
                    }
                    //联系人2手机校验
                    if (ds.fields.phone_2) {
                        ds.fields.phone_2.pro.validator = phone_validate;
                    }
                    //联系人3手机校验
                    if (ds.fields.phone_3) {
                        ds.fields.phone_3.pro.validator = phone_validate;
                    }
                }
            };
            
            function down_payment_validate(record, name, value) {
                var down_payment_ratio_from = record.get('down_payment_ratio_from') || 0;
                var down_payment_ratio_to = record.get('down_payment_ratio_to') || 1;
                var invoice_price = record.get('invoice_price') || 0;
                var insurance_amount = record.get('insurance_amount') || 0;
                var purchase_tax = record.get('purchase_tax') || 0;
                var plate_price = record.get('plate_price') || 0;
                var lease_charge = record.get('lease_charge');
                var down_payment_ratio = parseInt(value) / (parseInt(invoice_price) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(plate_price));
                var finance_amount = parseInt(invoice_price) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(plate_price) - parseInt(value);
                if (down_payment_ratio < down_payment_ratio_from || down_payment_ratio > down_payment_ratio_to) {
                    Aurora.showMessage('提示', '首付比例只能在' + down_payment_ratio_from * 100 + '到' + down_payment_ratio_to * 100 + '之间！');
                    return 'false';
                }
                record.set('down_payment_ratio', down_payment_ratio);
                record.set('finance_amount', finance_amount);
                return true;
            }
            
            function plate_price_validate(record, name, value) {
                var invoice_price = record.get('invoice_price') || 0;
                var insurance_amount = record.get('insurance_amount') || 0;
                var purchase_tax = record.get('purchase_tax') || 0;
                var down_payment = record.get('down_payment') || 0;
                var finance_amount = parseInt(invoice_price) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(value) - parseInt(down_payment);
                var down_payment_ratio = parseInt(down_payment) / (parseInt(value) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(invoice_price));
                record.set('finance_amount', finance_amount);
                record.set('down_payment_ratio', down_payment_ratio);
                return true;
            }
            
            function insurance_amount_validate(record, name, value) {
                var invoice_price = record.get('invoice_price') || 0;
                var plate_price = record.get('plate_price') || 0;
                var purchase_tax = record.get('purchase_tax') || 0;
                var down_payment = record.get('down_payment') || 0;
                var finance_amount = parseInt(invoice_price) + parseInt(plate_price) + parseInt(purchase_tax) + parseInt(value) - parseInt(down_payment);
                var down_payment_ratio = parseInt(down_payment) / (parseInt(value) + parseInt(plate_price) + parseInt(purchase_tax) + parseInt(invoice_price));
                record.set('finance_amount', finance_amount);
                record.set('down_payment_ratio', down_payment_ratio);
                return true;
            }
            
            function purchase_tax_validate(record, name, value) {
                var invoice_price = record.get('invoice_price') || 0;
                var insurance_amount = record.get('insurance_amount') || 0;
                var plate_price = record.get('plate_price') || 0;
                var down_payment = record.get('down_payment') || 0;
                var finance_amount = parseInt(invoice_price) + parseInt(insurance_amount) + parseInt(plate_price) + parseInt(value) - parseInt(down_payment);
                var down_payment_ratio = parseInt(down_payment) / (parseInt(value) + parseInt(insurance_amount) + parseInt(plate_price) + parseInt(invoice_price));
                record.set('finance_amount', finance_amount);
                record.set('down_payment_ratio', down_payment_ratio);
                return true;
            }
            
            function lease_charge_validate(record, name, value) {
                var finance_amount = record.get('finance_amount');
                var lease_charge_ratio;
                if (!finance_amount) {
                    lease_charge_ratio = 0;
                } else {
                    lease_charge_ratio = parseInt(value) / parseInt(finance_amount);
                }
                record.set('lease_charge_ratio', lease_charge_ratio);
                return true;
            }
            
            function finance_amount_validate(record, name, value) {
                var deposit_ratio = record.get('deposit_ratio') || 0;
                var deposit = parseFloat(deposit_ratio) * parseInt(value);
                var lease_charge = record.get('lease_charge') || 0;
                var finance_amount_from = record.get('finance_amount_from') || 0;
                var finance_amount_to = record.get('finance_amount_to') || 99999999999;
                var lease_charge_ratio;
                if (value < finance_amount_from || value > finance_amount_to) {
                    Aurora.showMessage('提示', '超出范围，请重新选择融资方案！');
                    return '请填写' + finance_amount_from + '到' + finance_amount_to + '之间的数字';
                }
                if (value != 0) {
                    lease_charge_ratio = parseInt(lease_charge) / parseInt(value);
                } else {
                    lease_charge_ratio = 0;
                }
                record.set('deposit', deposit);
                record.set('lease_charge_ratio', lease_charge_ratio);
                return true;
            }
            
            function invoice_price_validate(record, name, value) {
                var down_payment = record.get('down_payment');
                var insurance_amount = record.get('insurance_amount') || 0;
                var purchase_tax = record.get('purchase_tax') || 0;
                var plate_price = record.get('plate_price') || 0;
                var guide_price = record.get('guide_price') || 9999999999;
                if (value > guide_price) {
                    Aurora.showMessage('提示', '购置价不能大于指导价！');
                    return '购置价不能大于指导价';
                }
                if (down_payment) {
                    var finance_amount = parseInt(value) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(plate_price) - parseInt(down_payment);
                    record.set('finance_amount', finance_amount);
                    var down_payment_ratio = parseInt(down_payment) / (parseInt(value) + parseInt(insurance_amount) + parseInt(purchase_tax) + parseInt(plate_price));
                    record.set('down_payment_ratio', down_payment_ratio);
                }
                return true;
            }
            
            function guide_price_validate(record, name, value) {
                record.set('invoice_price', record.get('invoice_price'));
                return true;
            }
            
            
            //加载时调用(grid,table,gridBox)
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record, config_records, bp_seq) {
            
                //add by wdd
                var hl_prj_overrule_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hl_prj_overrule');
                if (ds.id == hl_prj_overrule_id) {
            
                    hl_prj_overrule_grid_length = $(hl_prj_overrule_id).getAll().length;
            
                    var hl_prj_overrule_record = $(hl_prj_overrule_id).getAll();
                    if (hl_prj_overrule_record.length) {
                        for (var i = 0;i < hl_prj_overrule_record.length;i++) {
            
                            var line_record = hl_prj_overrule_record[i];
                            var return_person = line_record.get('return_person');
                            if (return_person != ${/session/@user_id}) {
                                line_record.getField('return_reason').setReadOnly(true);
                            }
                        }
                    }
                }
                //end by wdd
                //如果存在的话，进行校验逻辑  排除掉联系人校验
                if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('GUR_NP') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                    //担保人身份证校验
                    if (ds.fields.id_card_no) {
                        ds.fields.id_card_no.pro.validator = gur_id_card_no_validate;
                    }
                    //担保人手机验证
                    if (ds.fields.cell_phone) {
                        ds.fields.cell_phone.pro.validator = gur_cell_phone_validate;
                    }
                }
                // if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('GUR_ORG') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                // ds.fields.id_card_no.pro.validator = prj500n_card_id_check;
                // if (ds.fields.id_no_sp) {
                // ds.fields.id_no_sp.pro.validator = prj500n_card_id_check;
                // }
                // }
            };
            //新增时调用(grid,table,gridBox)
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_add'] = function(ds, record, config_records, bp_seq) {
            
                Aurora.request({
                    url: '${/request/@context_path}/autocrud/prj.PRJ500D.sys_date/query',
                    para: {},
                    success: function(res) {
                        var sysdate = res.result.record.sys_date;
                        record.set('return_time', sysdate);
                    },
                    error: function() {
            
                       },
                    failure: function() {
            
                       },
                    scope: this
                });
            
                //如果存在的话，进行校验逻辑  排除掉联系人校验
                if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('GUR_NP') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                    //担保人身份证校验
                    if (ds.fields.id_card_no) {
                        ds.fields.id_card_no.pro.validator = gur_id_card_no_validate;
                    }
                    //担保人手机验证
                    if (ds.fields.cell_phone) {
                        ds.fields.cell_phone.pro.validator = gur_cell_phone_validate;
                    }
                }
                // if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('GUR_ORG') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                // ds.fields.id_card_no.pro.validator = prj500n_card_id_check;
                // if (ds.fields.id_no_sp) {
                // ds.fields.id_no_sp.pro.validator = prj500n_card_id_check;
                // }
                // }
                return true;
            };
            //更新时调用
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
                var bp_info_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
                var lease_item_info_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_lease_item');
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_lease_item');
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_record = $(prj_project_ds_id).getAt(0);
                if (bp_info_ds_id == ds.id) {
                    if (name == 'work_type') {
                        $(lease_item_info_ds_id).getAt(0).getField('product_plan_id_n').setLovPara('work_type', record.get('work_type'));
                    }
                }
                if (lease_item_info_ds_id == ds.id) {
                    if (name == 'model_id_n') {
                        record.getField('product_plan_id_n').setLovPara('model_id', record.get('model_id'));
                    }
                }
                if (ds_id == ds.id) {
                    if (name == 'lease_times') {
                        if (!value) {
                            record.getField('lease_times').setReadOnly(false);
                        }
                    }
                    if (name == 'deposit_ratio') {
                        if (!value) {
                            record.getField('deposit_ratio').setReadOnly(false);
                        }
                    }
                } /*如果是project_bp相关的，进行身份证校验处理*/
                if ((ds.id).indexOf('prj_project_bp') != -1 && (ds.id).indexOf('prj_project_bp_contact_info') == -1) {
                    var id_type = record.get('id_type');
                    if (name == 'id_card_no') {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_info_id').getUrl(),
                            para: {
                                id_card_no: value,
                                id_type: id_type
                            },
                            success: function(data) {
                                if (data.result.record && !data.result.record.length) {
                                    //申请人信息
                                    for (var name in data.result.record) {
                                        if (name != 'bp_type' && name != 'bp_category') {
                                            record.set(name, data.result.record[name]);
                                        }
                                    }
                                    /* prj_record.set('bp_code', data.result.record['bp_code']);
                                     prj_record.set('bp_id_tenant', data.result.record['bp_id']); */
                                } else {
                                    /*  prj_record.set('bp_code', '');
                                     prj_record.set('bp_id_tenant', ''); */
                                }
            
            
                            },
                            failure: function() {
            
                               },
                            error: function() {
            
                               },
                            scope: this
                        });
                    } else if (name == 'business_license_num') {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}${/parameter/@pre_layout}get_organization_code_id').getUrl(),
                            para: {
                                business_license_num: value
                            },
                            success: function(data) {
                                if (data.result.record && !data.result.record.length) {
                                    //申请人信息
                                    for (var name in data.result.record) {
                                        if (name != 'bp_type' && name != 'bp_category') {
                                            record.set(name, data.result.record[name]);
                                        }
                                    }
                                    //prj_record.set('bp_code', data.result.record['bp_code']);
                                    //prj_record.set('bp_id_tenant', data.result.record['bp_id']);
                                } else {
                                    //prj_record.set('bp_code', '');
                                    //prj_record.set('bp_id_tenant', '');
                                }
            
            
                            },
                            failure: function() {
            
                               },
                            error: function() {
            
                               },
                            scope: this
                        });
                    }
            
                }
            
            
            };
            
            
            function id_card_no_validate(record, name, value) {
                //获取担保人ds
                var bp_gur_np_ds_id = get_dsid_by_tabcode_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'BP_GUR_NP', 'prj_project_bp');
                if (!value) {
                    return '身份证号不能为空';
                } else {
                    if (!checkCard(value)) {
                        Aurora.showMessage('提示', '申请人信息中，请输入正确格式的身份证！');
                        return '请输入正确格式的身份证';
                    }
                }
                if (value.length == 18) {
                    record.set('date_of_birth', new Date(value.substr(6, 4) + '/' + value.substr(10, 2) + '/' + value.substr(12, 2)));
                    record.set('age', new Date().getFullYear() - value.substr(6, 4));
                    if (value.substr(16, 1) % 2 == 1) {
                        record.set('gender', 'MALE');
                        record.set('gender_n', '男');
                    } else if (value.substr(16, 1) % 2 == 0) {
                        record.set('gender', 'FEMALE');
                        record.set('gender_n', '女');
                    }
                    if (record.get('gender') == record.get('gender_sp')) {
                        Aurora.showMessage('提示', '申请人和申请人配偶的性别不能相同！');
                        record.set('gender_sp_n', '');
                        record.set('date_of_birth_sp', '');
                        record.set('age_sp', '');
                        record.set('id_no_sp', '');
                        return '申请人和申请人配偶的性别不能相同';
                    }
                }
                if ($(bp_gur_np_ds_id).getAt(0)) {
                    if (record.get('id_card_no') == $(bp_gur_np_ds_id).getAt(0).get('id_card_no')) {
                        Aurora.showMessage('提示', '申请人和担保人的身份证不能相同！');
                        record.set('id_no_sp', '');
                        record.set('id_card_no', '');
                        record.set('gender_n', '');
                        record.set('date_of_birth', '');
                        record.set('age', '');
                        return '申请人和担保人的身份证不能相同';
                    }
                }
                return true;
            }
            
            function cell_phone_validate(record, name, value) {
                //获取担保人ds
                var bp_gur_np_ds_id = get_dsid_by_tabcode_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'BP_GUR_NP', 'prj_project_bp');
                var bp_contact_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp_contact_info');
                
				if (!checkMobile(value)) {
                    Aurora.showMessage('提示', '申请人信息中，请输入正确格式的手机号码！');
                    return '请输入正确格式的手机号码';
                }
                if (record.get('cell_phone') == record.get('cell_phone_sp')) {
                    Aurora.showMessage('提示', '申请人和申请人配偶的手机号不能相同！');
                    return '申请人和申请人配偶的手机号不能相同';
                }
                if (!Ext.isEmpty($(bp_gur_np_ds_id).getAt(0))) {
                    if (record.get('cell_phone') == ($(bp_gur_np_ds_id).getAt(0).get('cell_phone') || 0)) {
                        Aurora.showMessage('提示', '申请人和担保人的手机号不能相同！');
                        return '申请人和担保人的手机号不能相同';
                    }
                }
                if (!Ext.isEmpty($(bp_contact_id).getAt(0))) {
                    if (record.get('cell_phone') == $(bp_contact_id).getAt(0).get('phone') || record.get('cell_phone') == $(bp_contact_id).getAt(0).get('phone_2') || record.get('cell_phone') == $(bp_contact_id).getAt(0).get('phone_3')) {
                        Aurora.showMessage('提示', '联系人和申请人的手机号不能一样！');
                        return '联系人和申请人的手机号不能一样';
                    }
                }
                return true;
            }
            
            function marital_status_validate(record, name, value) {
                record.getField('id_no_sp').setRequired(false);
                record.getField('bp_name_sp').setRequired(false);
                // record.getField('bp_name_sp').setReadOnly(true);
                // record.getField('id_no_sp').setReadOnly(true);
                // record.getField('cell_phone_sp').setReadOnly(true);
                // record.getField('work_unit_name_sp').setReadOnly(true);
                // record.getField('work_type_sp_n').setReadOnly(true);
            
                return true;
            }
            
            function id_no_sp_validate(record, name, value) {
                if (!value) {
                    return true;
                } else {
                    var card_type_sp = record.get('card_type_sp');
                    if (card_type_sp == 'ID_CARD') {
                        if (!checkCard(value)) {
                            Aurora.showMessage('提示', '申请人配偶信息中，请输入正确格式的身份证！');
                            return '请输入正确格式的身份证';
                        }
                    }
                }
                if (value.length == 18) {
                    record.set('date_of_birth_sp', new Date(value.substr(6, 4) + '/' + value.substr(10, 2) + '/' + value.substr(12, 2)));
                    record.set('age_sp', new Date().getFullYear() - value.substr(6, 4));
                    if (value.substr(16, 1) % 2 == 1) {
                        record.set('gender_sp', 'MALE');
                        record.set('gender_sp_n', '男');
                    } else if (value.substr(16, 1) % 2 == 0) {
                        record.set('gender_sp', 'FEMALE');
                        record.set('gender_sp_n', '女');
                    }
                    if (record.get('gender') == record.get('gender_sp')) {
                        Aurora.showMessage('提示', '申请人和申请人配偶的性别不能相同！');
                        record.set('gender_sp_n', '');
                        record.set('date_of_birth_sp', '');
                        record.set('age_sp', '');
                        record.set('id_no_sp', '');
                        return '申请人和申请人配偶的性别不能相同';
                    }
                }
                return true;
            }
            
            function cell_phone_sp_validate(record, name, value) {
                if (!value) {
                    return true;
                }
                if (!checkMobile(value)) {
                    Aurora.showMessage('提示', '申请人配偶信息中，请输入正确格式的手机号码！');
                    return '请输入正确格式的手机号码';
                }
                if (record.get('cell_phone') == record.get('cell_phone_sp')) {
                    Aurora.showMessage('提示', '申请人和申请人配偶的手机号不能相同！');
                    return '申请人和申请人配偶的手机号不能相同';
                }
                return true;
            }
            
            function gur_id_card_no_validate(record, name, value) {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
                if (!value) {
                    return '身份证号不能为空';
                } else {
                    if (!checkCard(value)) {
                        Aurora.showMessage('提示', '担保人信息中，请输入正确格式的身份证！');
                        return '请输入正确格式的身份证';
                    }
                }
                if (value.length == 18) {
                    record.set('date_of_birth', new Date(value.substr(6, 4) + '/' + value.substr(10, 2) + '/' + value.substr(12, 2)));
                    record.set('age', new Date().getFullYear() - value.substr(6, 4));
                    if (value.substr(16, 1) % 2 == 1) {
                        record.set('gender', 'MALE');
                        record.set('gender_n', '男');
                    } else if (value.substr(16, 1) % 2 == 0) {
                        record.set('gender', 'FEMALE');
                        record.set('gender_n', '女');
                    }
                }
                if (record.get('id_card_no') == $(ds_id).getAt(0).get('id_card_no')) {
                    Aurora.showMessage('提示', '申请人和担保人的身份证不能相同！');
                    record.set('gender_n', '');
                    record.set('date_of_birth', '');
                    record.set('age', '');
                    return '申请人和担保人的身份证不能相同';
                }
                return true;
            }
            
            function gur_cell_phone_validate(record, name, value) {
                //获取申请人ds
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
                if (!checkMobile(value)) {
                    Aurora.showMessage('提示', '担保人信息中，请输入正确格式的手机号码！');
                    return '请输入正确格式的手机号码';
                }
                if (record.get('cell_phone') == $(ds_id).getAt(0).get('cell_phone')) {
                    record.set('cell_phone', '');
                    Aurora.showMessage('提示', '申请人和担保人的手机号不能相同！');
                    return '申请人和担保人的手机号不能相同';
                }
                return true;
            }
            
            function lease_times_validate(record, name, value) {
                var min_dp_ratio = record.get('min_dp_ratio');
                var times_limit = record.get('times_limit');
                var min_dp_ratio_visit = record.get('min_dp_ratio_visit');
                var times_limit_visit = record.get('times_limit_visit');
                var down_payment_ratio = record.get('down_payment_ratio');
                var lease_times_temp = record.get('lease_times_temp');
                if (down_payment_ratio != 'undefined') {
                    if (value == times_limit && down_payment_ratio >= min_dp_ratio) {
                        record.set('gps_install_flag', 'N');
                        record.set('gps_install_flag_n', '否');
                    } else {
                        record.set('gps_install_flag', 'Y');
                        record.set('gps_install_flag_n', '是');
                    }
                    if (value == times_limit_visit && down_payment_ratio >= min_dp_ratio_visit) {
                        record.set('visit_flag', 'N');
                        record.set('visit_flag_n', '否');
                    } else {
                        record.set('visit_flag', 'Y');
                        record.set('visit_flag_n', '是');
                    }
                }
                return true;
            }
            
            function down_payment_ratio_validate(record, name, value) {
                var down_payment_ratio_from = record.get('down_payment_ratio_from') || 0;
                var down_payment_ratio_to = record.get('down_payment_ratio_to') || 1;
                var min_dp_ratio = record.get('min_dp_ratio');
                var times_limit = record.get('times_limit');
                var min_dp_ratio_visit = record.get('min_dp_ratio_visit');
                var times_limit_visit = record.get('times_limit_visit');
                var lease_times = record.get('lease_times') || 0;
                if (value < down_payment_ratio_from || value > down_payment_ratio_to) {
                    Aurora.showMessage('提示', '首付比例只能在' + down_payment_ratio_from * 100 + '到' + down_payment_ratio_to * 100 + '之间！');
                    return '请填写' + down_payment_ratio_from * 100 + '到' + down_payment_ratio_to * 100 + '之间的数字';
                }
                if (lease_times == times_limit && value >= min_dp_ratio) {
                    record.set('gps_install_flag', 'N');
                    record.set('gps_install_flag_n', '否');
                } else {
                    record.set('gps_install_flag', 'Y');
                    record.set('gps_install_flag_n', '是');
                }
                if (lease_times == times_limit_visit && value >= min_dp_ratio_visit) {
                    record.set('visit_flag', 'N');
                    record.set('visit_flag_n', '否');
                } else {
                    record.set('visit_flag', 'Y');
                    record.set('visit_flag_n', '是');
                }
                return true;
            }
            
            function deposit_ratio_validate(record, name, value) {
                var finance_amount = record.get('finance_amount') || 0;
                var deposit = parseInt(finance_amount) * parseFloat(value);
                record.set('deposit', deposit);
                return true;
            }
            
            function deposit_validate(record, name, value) {
                var insurance_amount = record.get('insurance_amount') || 0;
                var purchase_tax = record.get('purchase_tax') || 0;
                var plate_price = record.get('plate_price') || 0;
                var lease_charge = record.get('lease_charge');
                var down_payment = record.get('down_payment');
                return true;
            }
            
            // function phone_validate(record, name, value) {
            // var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
            // var phone_0 = $(ds_id).getAt(0).get('id_card_no')
            // var phone_1 = record.get('phone');
            // var phone_2 = record.get('phone_2');
            // var phone_3 = record.get('phone_3');
            // if (phone_0 == phone_1 || phone_0 == phone_2 || phone_0 == phone_3) {
            // Aurora.showMessage('提示', '联系人和申请人的手机号不能一样！');
            // return '联系人和申请人的手机号不能一样';
            // }
            // if (phone_1 == phone_2 || phone_1 == phone_3 || phone_2 == phone_3) {
            // Aurora.showMessage('提示', '联系人的手机号不能一样！');
            // return '联系人的手机号不能一样';
            // }
            // return true;
            // }
            
            function phone_validate(record, name, value) {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
                var phone_0 = $(ds_id).getAt(0).get('cell_phone')
                var phone_1 = record.get('phone_1') || -1;
                var phone_2 = record.get('phone_2') || -2;
                var phone_3 = record.get('phone_3') || -3;
                if (phone_1 != -1) {
                    if (!checkMobile(phone_1)) {
                        Aurora.showMessage('提示', '联系人1信息中，请输入正确格式的手机号码！');
                        return '请输入正确格式的手机号码';
                    }
                }
                if (phone_2 != -2) {
                    if (!checkMobile(phone_2)) {
                        Aurora.showMessage('提示', '联系人2信息中，请输入正确格式的手机号码！');
                        return '请输入正确格式的手机号码';
                    }
                }
                if (phone_3 != -3) {
                    if (!checkMobile(phone_3)) {
                        Aurora.showMessage('提示', '联系人3信息中，请输入正确格式的手机号码！');
                        return '请输入正确格式的手机号码';
                    }
                }
                if (phone_0 == phone_1 || phone_0 == phone_2 || phone_0 == phone_3) {
                    Aurora.showMessage('提示', '联系人和申请人的手机号不能一样！');
                    return '联系人和申请人的手机号不能一样';
                }
                if (phone_1 == phone_2 || phone_1 == phone_3 || phone_2 == phone_3) {
                    Aurora.showMessage('提示', '联系人的手机号不能一样！');
                    return '联系人的手机号不能一样';
                }
                return true;
            }
            
            function product_plan_id_validate(record, name, value) {
                var down_payment_ratio = record.get('down_payment_ratio');
                var finance_amount = record.get('finance_amount');
                if (down_payment_ratio) {
                    record.set('down_payment_ratio', down_payment_ratio);
                }
                if (finance_amount) {
                    record.set('finance_amount', finance_amount);
                }
                return true;
            }
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
