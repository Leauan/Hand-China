<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: wangwei5743  
    $Date: 2014-10-8 下午3:16:19  
    $Revision: 1.0  
    $purpose: 租赁申请创建  创建界面       
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure>
        <a:model-query defaultWhereClause="t1.user_id=${/session/@user_id}" model="prj.PRJ500D.sys_user_lv" rootPath="user_name_path"/>
    </a:init-procedure>
    <a:view>
	    <a:link id="${/parameter/@layout_code}_prj500_cdd_downloadFile_id" url="${/request/@context_path}/uploadOnlyFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_car_organization_id" model="prj.PRJ500D.yonda_car_organization" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_special_fields_link_id" model="cont.CON500.con_contract_get_special_fields" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_calc_id" model="prj.PRJ500D.calc_quotation" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}check_product_package_bag_link_id" model="prj.PRJ500D.prj_project_before_workflow_start" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}submit_approval_link" model="prj.PRJ500D.prj_project_workflow_start" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_info_id" model="prj.PRJ500D.hls_bp_master_np_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_organization_code_id" model="prj.PRJ500D.hls_bp_master_org_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_info_guar_id" model="prj.PRJ500D.hls_bp_master_np_guar" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_org_code_info_guar_id" model="prj.PRJ500D.hls_bp_master_org_guar" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_id_card_no_tenant_sec_id" model="prj.PRJ500D.hls_bp_master_np_tenant_sec_v" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}user_id_query_link" model="prj.PRJ500D.sys_user_lv" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_calc_validate_sql_link" model="prj.PRJ500D.prj_get_calc_validate_sql" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_car_organization_id_link" model="prj.PRJ500D.get_hls_car_organization" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_company_distrct_link" model="prj.PRJ500D.get_company_info" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_bp_id_invoice_link" model="prj.PRJ500D.get_bp_id_invoice" modelaction="query"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}get_atch_download_link" url="${/request/@context_path}/modules/batch_download/lease_atm_batch_dl.svc"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj_project_dowload_uploadfile" url="${/request/@context_path}/modules/prj/lease_atm_batch_dl.svc"/>
        <script src="${/request/@context_path}/modules/prj/PRJ500N/javascripts/input_validator.js"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}con_item_frame_number_link" model="cont.CON501N.con_item_frame_number" modelaction="execute"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@pre_layout}prj501n_analyse_detail_link" url="${/request/@context_path}/modules/prj/PRJ501N/prj_analyse_detail.screen"/>
        <!-- <link href="${/request/@context_path}/css/lightbox.css" rel="stylesheet" type="text/css"/>-->
        <!-- <script src="${/request/@context_path}/javascripts/lightbox.js"/>-->
        <!-- <script src="${/request/@context_path}/modules/prj/PRJ500N/javascripts/check_org_code.js"/> -->
		<link href="${/request/@context_path}/viewerjs/viewer.css" rel="stylesheet"/>
        <script src="${/request/@context_path}/viewerjs/viewer.js"/>
        <script src="${/request/@context_path}/viewerjs/viewer_tool.js"/>
        <script><![CDATA[
            //Ext.ux.Lightbox.register('a[ref=img]',true);    
            //提交审批
            var submit_wfl_flag = 'N';
            //提交审批
            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
                window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认提交？', function() {
                    window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
                    var root_ds_1 = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds_1.validate()) {
                        submit_wfl_flag = 'Y';
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                    }
                });
            };
            window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_project_record = $(prj_project_ds_id).getAt(0);
                var project_id = prj_project_record.get('project_id');
                var project_number = prj_project_record.get('project_number');
                var doc_code = project_number;
                var url_l = $('${/parameter/@layout_code}${/parameter/@pre_layout}prj_project_dowload_uploadfile').getUrl() + '?document_id=' + project_id + '&document_table=PRJ_PROJECT' + '&doc_code=' + encodeURI(doc_code) + '&all_flag=Y';
                window.open(href = url_l, target = "_self");
            
            };
            
            //保存submitsuccess调用
            window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'] = function(ds, record, res) {
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                if (submit_wfl_flag == 'Y') {
                    submit_wfl_flag = 'N';
                    Aurora.request({
                        url: $('${/parameter/@layout_code}${/parameter/@pre_layout}submit_approval_link').getUrl(),
                        para: {
                            project_id: $(ds_id).getAt(0).get('project_id')
                        },
                        success: function() {
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            $('${/parameter/@winid}').close();
                            Aurora.SideBar.show({
                                msg: '操作成功',
                                duration: 2000
                            });
                        },
                        failure: function() {
                            submit_wfl_flag = 'N';
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        error: function() {
                            submit_wfl_flag = 'N';
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        scope: this
                    });
            
                } else {
                    if (ds_id) {
                        record = $(ds_id).getAt(0);
                        var cdd_item_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
                        $(cdd_item_ds_id).setQueryParameter('cdd_list_id', record.get('cdd_list_id'));
                        $(cdd_item_ds_id).query();
                        var prj_cdd_item_doc_ref_ds = $(cdd_item_ds_id);
            
                        function prj_cdd_item_doc_ref_load() {
                            //取消重复监听
                            prj_cdd_item_doc_ref_ds.un('load', prj_cdd_item_doc_ref_load);
                            $(cdd_item_ds_id).submit();
                        }
                        prj_cdd_item_doc_ref_ds.on('load', prj_cdd_item_doc_ref_load);
                        var ln_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_fin_calculator_ln');
                        var quotation_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_quotation');
                        $(ln_ds_id).query();
                        $(quotation_ds_id).query();
                    }
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                }
            
            
                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
            };
            
            function upload_file(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('check_id')) {
                    var url;
                    if (query_only == 'Y') {
					     url = $('${/parameter/@layout_code}_prj500_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                        //url = $('${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    } else {
                        url = $('${/parameter/@layout_code}${/parameter/@pre_layout}prj500_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: 'prj500_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
            
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            }
            
            /* function prj501_open_analyse_win(record_id, ds_id, condition_code) {
                var record = $(ds_id).findById(record_id);
                var param = {};
                param['target_type'] = record.get('target_type');
                param['target'] = record.get('target');
                param['condition_code'] = condition_code;
                param['layout_code'] = 'PRJ_ANALYSE_DETAIL';
                param['winid'] = 'prj501n_analyse_detail_win';
                param['function_usage'] = 'QUERY';
                var win = new Aurora.Window({
                    id: 'prj501n_analyse_detail_win',
                    params: param,
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}prj501n_analyse_detail_link').getUrl(),
                    title: '维度明细('+'PRJ_ANALYSE_DETAIL)',
                    fullScreen: true,
                    draggable: true
                });
            } */
            window['${/parameter/@layout_code}${/parameter/@pre_layout}prj501_open_analyse_win'] = function(record_id, ds_id, condition_code) {
                var record = $(ds_id).findById(record_id);
                var param = {};
                param['target_type'] = record.get('target_type');
                param['target'] = record.get('target');
                param['condition_code'] = condition_code;
                param['layout_code'] = 'PRJ_ANALYSE_DETAIL';
                param['winid'] = 'prj501n_analyse_detail_win';
                param['function_usage'] = 'QUERY';
                var win = new Aurora.Window({
                    id: 'prj501n_analyse_detail_win',
                    params: param,
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}prj501n_analyse_detail_link').getUrl(),
                    title: '维度明细('+'PRJ_ANALYSE_DETAIL)',
                    fullScreen: true,
                    draggable: true
                });
            }; 
            
            //超链接渲染
            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
                var link_function = '';
                window['${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
                if (name == 'attachment') {
                    link_function = 'upload_file';
					return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + 'Y' + '\');">' + config_record.get('prompt') + '</a>';
                    //return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                } else if (name == 'attach_file_name') {
                    if (value != null) {
                        var link = '${/request/@context_path}/atm_download.svc?attachment_id=';
                        var str = value.split(';;');
                        var url = '';
                        for (var i = 0;i < str.length;i++) {
                            var temp = str[i].split('--');
                            if (!Aurora.isEmpty(temp[0])) {
                                //url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                var file_suffix = temp[0].substr(temp[0].lastIndexOf('.') + 1).toUpperCase();
                                if (file_suffix == 'BMP' || file_suffix == 'JPG' || file_suffix == 'JPEG' || file_suffix == 'PNG' || file_suffix == 'GIF') {
                                    // url = url + '<a ref="img" href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                    link_function = 'show_viewer_more';
                                    url = url + '<a href="javascript:window[\'' + link_function + '\'](\'' + link + '\',\'' + temp[1] + '\',\'' + temp[0] + '\',\'' + value + '\');">' + temp[0] + '</a>' + ',';
                                } else {
                                    url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                }
                            }
                        }
                        return url;
            
                    }
                } else if (name == 'description') {
                    if (record.get('important_flag') == 'Y') {
                        return '<font color="RED">' + value + '</font>';
                    }
                    return value;
                } else if (name == 'approved_count' || name == 'reject_count' || name == 'cancel_count' || name == 'terminate_count' || name == 'new_count') {
                    var condition_code;
                    if (name === 'approved_count') {
                        condition_code = '11';
                    } else if (name === 'reject_count') {
                        condition_code = '12';
                    } else if (name === 'cancel_count') {
                        condition_code = '13';
                    } else if (name === 'terminate_count') {
                        condition_code = '14';
                    }else if (name === 'new_count') {
                        condition_code = '15';
                    }
                    if (value > 0) {
                        return '<a href="javascript:${/parameter/@layout_code}${/parameter/@pre_layout}prj501_open_analyse_win(\'' + record.id + '\',\'' + record.ds.id + '\',\'' + condition_code + '\')">' + value + '</a>';
                    } else {
                        return value;
                    }
            
                }
            }; /*查询前调用*/
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_record = $(prj_project_ds_id).getAt(0);
                qpara.project_id = prj_record.get('project_id');
            }; /*保存前调用，生成项目编号*/
            window['${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function(ds, record) {
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                var prj_project_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                var prj_record = $(prj_project_ds_id).getAt(0);
                var check_flag = false;
                if (prj_record.get('project_number')) {
                    return true;
                }
                Aurora.request({
                    url: $('${/parameter/@layout_code}${/parameter/@pre_layout}get_special_fields_link_id').getUrl(),
                    para: {
                        document_category: '${/parameter/@document_category}',
                        document_type: record.get('document_type'),
                        function_code: '${/parameter/@function_code}',
                        function_usage: '${/parameter/@function_usage}'
                    },
                    success: function(res) {
                        var document_number = res.result.document_number;
                        prj_record.set('project_number', document_number);
                        check_flag = true;
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    error: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    failure: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    },
                    sync: true,
                    scope: this
                });
                return check_flag;
            
            };
  
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
