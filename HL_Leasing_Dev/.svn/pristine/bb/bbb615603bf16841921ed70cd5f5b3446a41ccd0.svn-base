<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author:Yenick  
    $Date: 2018-5-08
    $Revision: 1.0  
    $Purpose:农行代扣数据导入
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure><![CDATA[
    ]]></a:init-procedure>
    <a:view>
        <a:link id="${/parameter/@layout_code}_con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
        <a:link id="hls_ebank_input_detail_link" url="${/request/@context_path}/modules/hls_acr/HLS_ACR5040/hls_acr_ebank_input_detail.screen"/>
        <a:link id="hls_ebank_input_delete_link" model="hls_acr.HLS_ACR5040.hls_acr_import_data_delete" modelaction="delete"/>
        <script><![CDATA[
            //modify by wdd 20180530 for HL
            //增加删除按钮，同时删除头行数据
            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_acr_ebank_output_hd_temp');
                var hd_ds = $(ds_id);
                var records = hd_ds.getSelected();
                Aurora.showConfirm('${l:PROMPT}', '是否确定删除？', function() {
                    var detail_mask = Ext.getBody();
                    Aurora.Masker.mask(detail_mask, '${l:HLS.EXECUTING}');
                    if (records.length) {
                        for (var i = 0;i < records.length;i++) {
                            var line_record = records[i];
                            if (line_record.get('handle_flag') == 'Y') {
                                Aurora.showErrorMessage('${l:PROMPT}', '该笔数据已被核销，不能删除!');
                                Aurora.Masker.unmask(detail_mask);
                                return;
                            }
                            var output_hd_id = line_record.get('output_hd_id');
                            Aurora.request({
                                url: $('hls_ebank_input_delete_link').getUrl(),
                                para: {
                                    output_hd_id: output_hd_id
                                },
                                success: function() {
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    hd_ds.query(hd_ds.currentPage);
                                    Aurora.Masker.unmask(detail_mask);
                                },
                                failure: function() {
                                    Aurora.Masker.unmask(detail_mask);
                                },
                                error: function() {
                                    Aurora.Masker.unmask(detail_mask);
                                },
                                scope: this
                            });
                        }
                    }
                });
            };
            //end by wdd
            window['${/parameter/@layout_code}_upload_layout_dynamic_click'] = function() {
                var p_sourcetype = 'hls_acr_ebank_input';
                var p_pkvalue = '${/session/@session_id}';
                var url = '${/request/@context_path}/modules/hls_acr/HLS_ACR5030/hls_upload_for_attachment_db_view.screen?sourcetype=' + p_sourcetype + '&' + 'pkvalue=' + p_pkvalue;
                wd = new Aurora.Window({
                    id: 'attachment_up_window',
                    url: url,
                    title: '附件上传',
                    height: 350,
                    width: 850
                });
            };
            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record, bp_seq) {
                var link_function = '';
                window['${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
                if (name == 'output_number' && record.get('output_hd_id')) {
                    link_function = '${/parameter/@layout_code}_open_input_detail_window';
                    return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');">' + value + '</a>';
                }
            };
            
            window['${/parameter/@layout_code}_open_input_detail_window'] = function(id, name) {
                //debugger;
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                var param = {};
                // alert(record.get('output_id'));
                param['output_id'] = record.get('output_hd_id');
                param['function_code'] = 'HLS_ACR5040D';
                param['function_usage'] = 'QUERY';
                param['url_title'] = '明细';
                hls_doc_get_layout_code('${/parameter/@layout_code}_con_contract_get_layout_code_link_id', param, 'hls_ebank_input_detail_link', null, null);
            };
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
