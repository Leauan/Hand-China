<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: gaoyang 
    $Date: 2015-6-10 下午04:25:59  
    $Revision: 1.0  
    $Purpose: 
-->
<a:service xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <s:server-script><![CDATA[
            var request = $ctx['_instance.javax.servlet.http.HttpServletRequest'];
            var response = $ctx['_instance.javax.servlet.http.HttpServletResponse'];
            importPackage(java.io);
            
            function transfer(fis, os) {
                var b = new java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024 * 64);
                var len = -1;
                while ((len = fis.read(b)) != -1) {
                    os.write(b, 0, len);
                }
                fis.close();
            }
            var file_name = $ctx.parameter.file_name;
            var file_path = $ctx.parameter.file_path;
            if ($ctx.parameter.attachment_id) {
                var file_bm = $bm('fnd.fnd_atm_attachment');
                file_bm_map = file_bm.queryAsMap({
                    'attachment_id': $ctx.parameter.attachment_id
                });
                file_bm_childs = file_bm_map.getChildren();
                println(file_bm_childs[0].file_name);
                println(file_bm_childs[0].file_path);
                if (file_bm_childs.length) {
                    file_name = file_bm_childs[0].file_name;
                    file_path = file_bm_childs[0].file_path;
                }
            }
            $ctx["__request_type__"] = 'file';
            var resp = $ctx['_instance.javax.servlet.http.HttpServletResponse'];
            resp.setHeader("Pragma", "No-cache");
            resp.setHeader("Cache-Control", "no-cache, must-revalidate");
            resp.setDateHeader("Expires", 0);
            resp.setContentType("application/octet-stream");
            try {
                var fis = new FileInputStream(file_path);
                resp.setHeader("Content-Disposition", "inline; filename=" + encodeURI($ctx.parameter.file_name, 'utf-8'));
                var os = resp.getOutputStream();
                transfer(fis, os);
                os.flush();
            } catch (e) {
                var logger = $logger("server-script");
                logger.severe(e.message);
            }
        ]]></s:server-script>
    </a:init-procedure>
</a:service>
