<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: gaoyang 
    $Date: 2015-6-10 下午04:25:59  
    $Revision: 1.0  
    $Purpose: 
-->
<a:service xmlns:p="uncertain.proc" xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="cont.CON500.con_contract_get_guid_file_name" rootPath="guid_file_name_path"/>
        <a:model-query fetchAll="true" model="cont.CON500.con_doc_file_templet_get_atm" rootPath="file_templet_get_atm_path"/>
        <s:server-script><![CDATA[
            importPackage(java.io);
            
            function copyFile(fOld, fNew) {
                var fis = new java.io.FileInputStream(fOld);
                var fos = new java.io.FileOutputStream(fNew);
                var b = new java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024 * 4);
                var len = -1;
                while ((len = fis.read(b)) != -1) {
                    fos.write(b, 0, len);
                }
                fis.close();
                fos.close();
            }
            var from_file_data = $ctx.get('/model/file_templet_get_atm_path').getChildren();
            for (var i = 0;i < from_file_data.length;i++) {
                var to_file_path = $ctx.parameter.file_path;
                var record_data = from_file_data[i];
                if (record_data.file_exists_flag != 'Y') {
                    var to_file_name = record_data.to_file_name + '.doc';
                    var from_file_path = record_data.file_path;
                    var guid_file_name_path = $bm('cont.CON500.con_contract_get_guid_file_name').queryAsMap();
                    var guid_file_name_tables = guid_file_name_path.getChildren();
                    to_file_path = to_file_path + guid_file_name_tables[0].guid_file_name;
                    copyFile(from_file_path, to_file_path);
                    $bm('cont.CON500.con_file_content_copy_update').update({
                        table_name: 'CON_CONTRACT_CONTENT',
                        content_id: record_data.content_id,
                        file_name: to_file_name.toString(),
                        file_path: to_file_path.toString()
                    });
                    $ctx.parameter.first_copy_flag = 'Y';
                } else {
                    $ctx.parameter.first_copy_flag = 'N';
                }
            }
        ]]></s:server-script>
        <p:echo/>
    </a:init-procedure>
    <a:service-output output="/parameter"/>
</a:service>
