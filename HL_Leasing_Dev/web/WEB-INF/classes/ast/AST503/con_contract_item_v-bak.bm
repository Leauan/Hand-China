<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: qm  
    $Date: 2014-4-18 下午3:54:53  
    $Revision: 1.0  
    $Purpose: 
-->
<bm:model xmlns:e="aurora.service.exception" xmlns:f="aurora.database.features" xmlns:bm="http://www.aurora-framework.org/schema/bm" alias="t1" baseTable="CON_CONTRACT_ITEM_V">
    <bm:fields>
        <bm:field name="bp_id"/>
        <bm:field name="bp_name"/>
        <!--   <bm:field name="project_id"/>
        <bm:field name="document_type"/>
        <bm:field name="document_category"/> -->
        <bm:field name="contract_id"/>
        <bm:field name="contract_lease_item_id"/>
        <bm:field name="item_detail_id"/>
        <bm:field name="brand_id"/>
        <bm:field name="brand_dis"/>
        <bm:field name="model_id"/>
        <bm:field name="model_dis"/>
        <bm:field name="series_id"/>
        <bm:field name="series_dis"/>
        <bm:field name="pattern"/>
        <!--   <bm:field name="model_id"/>
        <bm:field name="model_dis"/> -->
        <!-- <bm:field name="contract_name"/> -->
        <bm:field name="contract_number"/>
        <bm:field name="color_of_apprearance"/>
        <!-- <bm:field name="color_of_decoration"/> -->
        <bm:field name="item_frame_number"/>
        <bm:field name="item_engine_number"/>
        <!--         <bm:field name="purchase_tax"/> -->
        <!--         <bm:field name="purchase_fee"/> -->
        <!--         <bm:field name="badge_price"/>
        <bm:field name="badge_license_fee"/> -->
        <!--        <bm:field name="insurance_price"/> -->
        <!--  <bm:field name="badge_fee"/>
        <bm:field name="gps_fee"/> -->
        <bm:field name="key_flag"/>
        <bm:field name="registration_flag"/>
        <bm:field name="purchase_flag"/>
        <bm:field name="insurance_flag"/>
        <bm:field name="gps_install_flag"/>
        <bm:field name="third_party_insurance"/>
        <bm:field name="accident_insurance_flag"/>
        <bm:field name="damage_insurance_flag"/>
        <bm:field name="damage_nopay_insurance_flag"/>
        <bm:field name="rot_insurance_flag"/>
        <bm:field name="third_party_insurance_desc"/>
        <bm:field name="exist_flag"/>
        <bm:field name="unit_id"/>
        <bm:field name="unit_id_n"/>
        <bm:field name="project_number"/>
        <bm:field name="invoice_agent_name"/>
        <bm:field name="lease_item_amount"/>
        <bm:field name="total_unrec_principal"/>
        <bm:field name="count_write_off_flag"/>
        <bm:field name="is_overtime"/>
        <bm:field name="is_in_pool"/>
        <bm:field name="license_number"/>
    </bm:fields>
    <bm:data-filters>
        <bm:data-filter enforceOperations="query" expression="exists (select 1               from yonda_doc_status_history h              where h.document_id = t.contract_id                and h.document_category = &apos;CONTRACT&apos;                and h.status = &apos;280&apos;)"/>
        <!-- <bm:data-filter name="query" expression="(exists (select 1 from ast_car_gps acg where acg.item_detail_id=t.item_detail_id and t.gps_install_flag=&apos;Y&apos;) or t.gps_install_flag=&apos;N&apos;)"/> -->
    </bm:data-filters>
    <bm:query-fields>
        <bm:query-field field="bp_name" queryExpression="bp_name like &apos;%&apos;|| ${@bp_name} || &apos;%&apos;"/>
        <!-- <bm:query-field field="series_id" queryOperator="="/> -->
        <!-- <bm:query-field field="model_id" queryOperator="="/> -->
        <bm:query-field field="exist_flag" queryOperator="="/>
        <bm:query-field field="brand_id" queryOperator="="/>
        <bm:query-field field="model_id" queryOperator="="/>
        <bm:query-field field="series_id" queryOperator="="/>
        <bm:query-field name="contract_number" queryExpression="contract_number like &apos;%&apos;|| ${@contract_number} || &apos;%&apos;"/>
        <bm:query-field name="item_frame_number" queryExpression="item_frame_number like &apos;%&apos;||${@item_frame_number}||&apos;%&apos;"/>
        <bm:query-field name="company_authority" queryExpression="t.company_id in (select company_id from fnd_companies start with company_id =${@company_authority} connect by prior company_id = parent_biz_company_id)"/>
    </bm:query-fields>
    <bm:operations>
        <bm:operation name="query">
            <bm:query-sql><![CDATA[
					SELECT *
  FROM (SELECT t2.contract_number, --合同号
               t2.project_number, --申请号
               t2.bp_id_tenant_n bp_name, --承租人
               (select a.invoice_agent_id
                  from prj_project a
                 where a.project_id = t2.project_id
                   and rownum = 1) invoice_agent_id,
               (select b.bp_name
                  from prj_project a, hls_bp_master b
                 where a.project_id = t2.project_id
                   and a.invoice_agent_id = b.bp_id
                   and rownum = 1) invoice_agent_name, --代理商
               
               t2.lease_item_amount, --租赁总价款
                  (SELECT SUM(NVL(principal, 0) - NVL(received_principal, 0))
                  FROM con_contract_cashflow
                 WHERE contract_id = t2.contract_id
                   AND cf_item = 1
                   AND cf_status <> 'CANCEL') total_unrec_principal, -- 剩余本金总额
               (SELECT COUNT(CC.WRITE_OFF_FLAG)
                  FROM con_contract_cashflow cc
                 where cc.contract_id = 13
                   and cc.write_off_flag = 'FULL'
                   AND CC.CF_ITEM = 1) count_write_off_flag, --还款期数
               
               '' as is_overtime, --是否逾期
               '' as is_in_pool, --登记证是否入库
               t3.brand_id,
               t3.model_id,
               t3.series_id,
               (SELECT v.description
                  FROM hls_car_brands_vl v
                 WHERE v.brand_id = t3.brand_id) brand_dis, --品牌
               (SELECT v.description
                  FROM hls_car_model_vl v
                 WHERE v.model_id = t3.model_id) model_dis, --车型
               
               (SELECT v.description
                  FROM hls_car_series_vl v
                 WHERE v.series_id = t3.series_id) series_dis, --车系
                 
               t1.item_engine_number, --发动机号
               t1.item_frame_number, --车架号
             
               
               (SELECT e.description
                  FROM con_contract_lease_item c, hls_car_brands_vl e
                 WHERE c.contract_id = t2.contract_id
                   AND c.brand_id = e.brand_id) license_number, --车牌号
               t3.color_of_apprearance, --车辆颜色
               
               t3.pattern,
               t2.unit_id,
               t2.unit_id_n,
               t3.contract_lease_item_id,
               t1.item_detail_id,
               t2.company_id,
               t2.contract_id,
               t2.bp_id_tenant bp_id,
               t1.key_flag,
               t1.registration_flag,
               t1.purchase_flag,
               t1.insurance_flag,
               t3.third_party_insurance,
               (nvl((SELECT 'Y'
                      FROM dual
                     WHERE EXISTS
                     (SELECT 1
                              FROM ast_car_insurance t
                             WHERE t.item_detail_id = t1.item_detail_id)),
                    'N')) exist_flag,
               (select a.code_value_name
                  from sys_code_values_v a
                 where a.code = 'PRJ500D_THIRD_PARTY_RES_INSURCE'
                   and a.code_value = t3.third_party_insurance) third_party_insurance_desc,
               t3.accident_insurance_flag,
               t3.damage_insurance_flag,
               t3.damage_nopay_insurance_flag,
               t3.rot_insurance_flag,
               t1.gps_install_flag
          FROM con_contract_item_detail t1,
               con_contract_lv          t2,
               con_contract_lease_item  t3
         WHERE t1.contract_lease_item_id = t3.contract_lease_item_id
           AND t3.contract_id = t2.contract_id
           AND t2.data_class = 'NORMAL') t #WHERE_CLAUSE#
 ORDER BY contract_number DESC

			]]></bm:query-sql>
        </bm:operation>
        <!-- <bm:operation name="insert" >
        	<bm:update-sql >
        	</bm:update-sql>
        </bm:operation> <bm:field name="key_flag" />
        <bm:field name="registration_flag" />
        <bm:field name="purchase_flag" />
        <bm:field name="insurance_flag" />-->
        <bm:operation name="update">
            <bm:update-sql><![CDATA[
            	declare
            		v_length number;
            		e_frame_err exception;
            	begin
            		v_length:=length(${@item_frame_number});
            		if v_length != 17 then
            			raise e_frame_err;
            		end if;
	        		UPDATE
					    CON_CONTRACT_ITEM_DETAIL t1
					SET
					    t1.ITEM_FRAME_NUMBER =${@item_frame_number},
					    t1.ITEM_ENGINE_NUMBER=${@item_engine_number},
					    t1.key_flag		     =${@key_flag},
					    t1.registration_flag =${@registration_flag},
					    t1.purchase_flag     =${@purchase_flag},
					    t1.insurance_flag    =${@insurance_flag},
					    t1.LAST_UPDATED_BY   =${/session/@user_id},
					    t1.LAST_UPDATE_DATE  =sysdate
					WHERE
					    t1.ITEM_DETAIL_ID = ${@item_detail_id};
					exception
						when e_frame_err then 
							sys_raise_app_error_pkg.raise_user_define_error('CON_CONTRACT_ITEM_DETAIL_PKG.FRAME_NUMBER_ERROR',
                                                      ${/session/@user_id},
                                                      '',
                                                      '');
      						raise_application_error(sys_raise_app_error_pkg.c_error_number,sys_raise_app_error_pkg.g_err_line_id);
				end;
        	]]></bm:update-sql>
        </bm:operation>
    </bm:operations>
    <e:exception-descriptor-config>
        <e:exception-descriptor exception="java.sql.SQLException" handleClass="aurora.database.SQLExceptionDescriptor">
            <e:error-message code="1" message="车架号或发动机号不能重复"/>
        </e:exception-descriptor>
    </e:exception-descriptor-config>
</bm:model>
