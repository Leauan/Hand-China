<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:p="uncertain.proc" trace="true">
    <a:init-procedure>
        <a:model-query model="zjwfl.ZJWFL5120.zj_wfl_to_do_list_count" rootpath="to_do_list_count"/>
        <a:model-query model="zjwfl.ZJWFL5110.zj_wfl_to_do_title_count" rootPath="to_do_list_count_rp"/>
        <a:model-query model="zjwfl.ZJWFL5110.zj_wfl_to_do_list_others_count" rootpath="other_list_count"/>
        <!-- <a:model-query defaultWhereClause="t1.project_id=${/parameter/@project_id}" model="zjwfl.check_note_null"  rootPath="rerurn_flag_path" /> -->
    </a:init-procedure>
    <a:view>
        <a:link id="get_document_info_link" model="zjwfl.ZJWFL5110.zj_wfl_get_document_info" modelaction="query"/>
        <a:link id="pageLink_ZJWFL5120_wfl_approve" url="${/request/@context_path}/modules/zjwfl/ZJWFL5110/zj_wfl_approve.screen"/>
        <script><![CDATA[
            function query_zjwfl5120_toDoDs() {
                $("zjwfl5120_toDoDs").query();
            }

            function winOpen_ZJWFL5120_wfl_approve(instance_id, node_id, record_id, workflow_id, record_type) {
                var url_type;
                if (record_type == 'NOTICE') {
                    url_type = 'NOTICE';
                } else {
                    url_type = 'DISPLAY';
                }
                var win = new Aurora.Window({
                    id: 'zj_wfl_approve_win',
                    url: $('pageLink_ZJWFL5120_wfl_approve').getUrl(),
                    params: {
                        instance_id: instance_id,
                        node_id: node_id,
                        record_id: record_id,
                        workflow_id: workflow_id,
                        record_type: record_type,
                        url_type: url_type,
                        winid: 'zj_wfl_approve_win'
                    },
                    title: '工作流审批',
                    height: 500,
                    width: 860,
                    fullScreen: true
                });
                win.on('close', function() {
                    query_zjwfl5120_toDoDs();
                });
            }
            
            function render_zjwfl5120_toDoDs_table(value, record, name) {
                var record_type = record.get('record_type');
                var color_flag = record.get('color_flag');
                var return_flag = record.get('return_flag');
                if (name == 'document_info') {
                    if (record.get('workflow_code') == 'WFL_PRJ') {
                        if (record.get('isreturn') > 0) {
                            //return '<font color="red">'+value+'</font> ';
                            return value;
                        } else {
                            return value;
                        }
                    } else {
                        return value;
                    }
                }
            
                if (name == 'display_image') {
                    if (record.get('urgent_type') == 'cui') {
                        return '<img src="${/request/@context_path}/images/zjwfl/zjwfl_cui.gif" alt="unknown" />';
                    } else {
                        if (record_type == 'NOTICE') {
                            return '<img src="${/request/@context_path}/images/zjwfl/zjwfl_tong.gif"  alt="unknown" />';
                        } else {
                            return '<img src="${/request/@context_path}/images/zjwfl/zjwfl_dai.gif"  alt="unknown" />';
                        }
                    }
                } else if (name == 'view_detail') {
                    if (record.get('creation_date_format')) {
                        return '<a style= "text-decoration:underline;" href="javascript:winOpen_ZJWFL5120_wfl_approve(' + record.get('instance_id') + ',' + record.get('node_id') + ',' + record.get('record_id') + ',' + record.get('workflow_id') + ',\'' + record_type + '\');">明细</a>';
                      }
                     return ''; 
                } else if (name == 'workflow_info') {
                    if (typeof(value) == "undefined" || !value) {
                        return '';
                    } else {
            
                        if (color_flag == 'Y' || return_flag == 'Y')
                        //if('${/model/rerurn_flag_path/record/@rerurn_flag}' == 'Y')
                        {
                            return '<a href="javascript:winOpen_ZJWFL5120_wfl_approve(' + record.get('instance_id') + ',' + record.get('node_id') + ',' + record.get('record_id') + ',' + record.get('workflow_id') + ',\'' + record_type + '\');">' + "<font color='red'>" + value + "</font>" + '</a>';
                        } else {
                            return '<a href="javascript:winOpen_ZJWFL5120_wfl_approve(' + record.get('instance_id') + ',' + record.get('node_id') + ',' + record.get('record_id') + ',' + record.get('workflow_id') + ',\'' + record_type + '\');">' + value + '</a>';
                        }
                    }
                }
                return '';
            }
            
            
            function loadFunction(ds) {
                $('document_num_id').select(0);
                $('document_num_id').focus();
            }
            
            function document_info_renderer(value, record, name) {
                if (record.get('workflow_code') == 'WFL_PRJ' && record.get('seq_number') == '30') {
                    Aurora.request({
                        url: $('get_document_info_link').getUrl(),
                        para: {
                            document_info: record.get('document_info')
                        },
                        success: function(res) {
                            debugger;
                            if (res.result.record['isreturn'] > 0) {
                                debugger;
                                return '<font color="red">' + value + '</font> ';
                            } else {
                                debugger;
                                return value;
                            }
                        }
                    });
                }
            }
            //tree展开时，将tree高度加上展开起来的高度
            
            function tree_expand(tree, node) {
                var child_nodes_length = node.childNodes.length;
                if (node.isExpand) {
                    treegrid1_height = treegrid1_height + child_nodes_length * 25;
                }
            }
            //tree折叠时，将tree高度剪掉折叠起来的高度
            
            function tree_collapse(tree, node) {
                var child_nodes_length = node.childNodes.length;
                if (!node.isExpand) {
                    treegrid1_height = treegrid1_height - child_nodes_length * 25;
                }
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="zj_wfl_document_number_ds" autoCreate="true">
                <a:fields>
                    <a:field name="any_info"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="zjwfl5120_toDoDs" autoQuery="true" fetchAll="true" model="zjwfl.ZJWFL5120.zj_wfl_instance_node_recipient" queryDataSet="zj_wfl_document_number_ds" selectable="false">
                <a:fields>
                    <!--   <a:field name="credit_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/> -->
                    <a:field name="pending_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/>
                    <a:field name="order_seq"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="loadFunction"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:switch test="/model/to_do_list_count/record/@list_count">
            <a:case value="0">
                <div id="top_wfl_to_do" style="margin-left:10px;">
                    <script><![CDATA[
        				document.getElementById('top_wfl_to_do').style.width=''+Number(Aurora.getViewportWidth()-30)+'px';
        			]]></script>
                    <img src="${/request/@context_path}/images/home_page/home_page_to_do.jpg" style="margin-left:0px;margin-top:5px;"/>
                    <div style="float:right;">
                        <table style="margin-right:0px;margin-top:10px;border:0px;padding:0px;border-collapse:collapse;">
                            <tr>
                                <td style="font-weight:bold;">
                                    <span><![CDATA[您共有]]></span>
                                    <span style="color:red;"><![CDATA[${/model/to_do_list_count/record/@list_count}]]></span>
                                    <span><![CDATA[件待办事项]]></span>
                                </td>
                                <td>
                                    <a:textField name="any_info" id="document_num_id" bindTarget="zj_wfl_document_number_ds" prompt="" width="200">
                                        <a:events>
                                            <a:event name="enterdown" handler="query_zjwfl5120_toDoDs"/>
                                        </a:events>
                                    </a:textField>
                                </td>
                                <td>
                                    <a:button click="query_zjwfl5120_toDoDs" text="查询"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </a:case>
            <a:case value="*">
                <div id="top_wfl_to_do" style="margin-left:10px;">
                    <script><![CDATA[
        				document.getElementById('top_wfl_to_do').style.width=''+Number(Aurora.getViewportWidth()-30)+'px';
        			]]></script>
                    <img src="${/request/@context_path}/images/home_page/home_page_to_do.jpg" style="margin-left:0px;margin-top:5px;"/>
                    <div style="float:right;">
                        <table style="margin-right:0px;margin-top:10px;border:0px;padding:0px;border-collapse:collapse;">
                            <tr>
                                <td style="font-weight:bold;">
                                    <span><![CDATA[您共有]]></span>
                                    <span style="color:red;"><![CDATA[${/model/to_do_list_count/record/@list_count}]]></span>
                                    <span><![CDATA[件待办事项]]></span>
                                </td>
                                <td>
                                    <a:textField name="any_info" id="document_num_id" bindTarget="zj_wfl_document_number_ds" prompt="" width="200">
                                        <a:events>
                                            <a:event name="enterdown" handler="query_zjwfl5120_toDoDs"/>
                                        </a:events>
                                    </a:textField>
                                </td>
                                <td>
                                    <a:button click="query_zjwfl5120_toDoDs" text="查询"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div style="margin-left:10px;">
                    <a:treeGrid id="ZJWFL5120_result_tree" bindTarget="zjwfl5120_toDoDs" expandField="expand_flag" idField="child_workflow_desc" marginHeight="50" marginWidth="32" navBar="true" parentField="workflow_desc" sequenceField="order_seq" showCheckBox="true">
                        <a:columns>
                            <!-- <a:column name="display_image" align="center" prompt="" renderer="render_zjwfl5120_toDoDs_table"/> -->
                            <a:column name="child_workflow_desc" prompt="工作流"/>
                            <a:column name="workflow_info" prompt="工作流名称" renderer="render_zjwfl5120_toDoDs_table"/>
                            <a:column name="submitted_by_name" prompt="提交人"/>
                            <a:column name="document_info" autoAdjust="true" prompt="单据信息" renderer="render_zjwfl5120_toDoDs_table" resizable="true" width="10"/>
                            <!--<a:column name="times" prompt="期数"/>
                            <a:column name="down_payment_ratio" prompt="首付款比例"/>-->
                            <!--                             <a:column name="pending_flag" prompt="暂挂"/>
 -->
                            <!--  <a:column name="credit_flag" prompt="征信"/> -->
                            <!-- <a:column name="finance_amount" prompt="融资总额"/>
                            <a:column name="down_payment_ratio" prompt="首付款比例"/>
                            <a:column name="price_list_n" prompt="产品名称"/>
                            <a:column name="division" prompt="产品线"/> -->
                            <a:column name="creation_date_format" prompt="到达时间"/>
                            <a:column name="view_detail" align="center" prompt="明细" renderer="render_zjwfl5120_toDoDs_table"/>
                        </a:columns>
                        <a:events>
                            <a:event name="expand" handler="tree_expand"/>
                            <a:event name="collapse" handler="tree_collapse"/>
                        </a:events>
                    </a:treeGrid>
                </div>
            </a:case>
        </a:switch>
        <script><![CDATA[
            var to_do_title_count = ${/model/to_do_list_count_rp/record/@title_count};
            var to_do_list_count = ${/model/to_do_list_count/record/@list_count};
            //如果只有一个节点，则treegird高度设置为所有子节点的高度
            if (to_do_title_count == 1) {
                treegrid1_height = 28 * (to_do_list_count + 3);
            } else {
                treegrid1_height = 28 * (to_do_list_count + 2);
            }
            var screen_width = Aurora.getViewportWidth() - 100;
            
            if (Aurora.CmpManager.get('ZJWFL5120_result_tree')) {
                var treegrid = $('ZJWFL5120_result_tree');
                treegrid.setColumnSize('child_workflow_desc', Math.round(screen_width * 0.15));
                treegrid.setColumnSize('workflow_info', Math.round(screen_width * 0.20));
                treegrid.setColumnSize('submitted_by_name', Math.round(screen_width * 0.18));
                treegrid.setColumnSize('document_info', Math.round(screen_width * 0.21));
                treegrid.setColumnSize('times', Math.round(screen_width * 0.05));
                treegrid.setColumnSize('down_payment_ratio', Math.round(screen_width * 0.05));
                 // treegrid.setColumnSize('credit_flag', Math.round(screen_width * 0.05));
                 treegrid.setColumnSize('pending_flag', Math.round(screen_width * 0.05));
                //treegrid.setColumnSize('division', Math.round(screen_width * 0.05));
                treegrid.setColumnSize('creation_date_format', Math.round(screen_width * 0.11));
                treegrid.setColumnSize('view_detail', Math.round(screen_width * 0.05));
            }
        ]]></script>
    </a:view>
</a:screen>
