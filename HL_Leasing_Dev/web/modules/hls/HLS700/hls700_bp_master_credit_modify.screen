<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: zhuxianfei
    $Date: 2017年11月23日 下午1:34:27  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure/>
    <a:view>
        <a:link id="hls700_credit_modify_update_link" model="hls.HLS700.hls_bp_master_credit_modify" modelaction="batch_update"/>
        <script><![CDATA[
            function hls700_credit_modify_add() {
                $('hls700_credit_modify_grid_ds').showEditorByRecord($('hls700_credit_modify_result_ds').create());
            
            }
            
            function hls700_credit_detail__query() {
                $('hls700_credit_modify_result_ds').query();
            }
            
            
            function hls700_credit_detail_render(value, record, name) {
            
                return '<a href="javascript:hls700_grid_update(' + record.get('bp_credit_hd_id') + ')">分配</a>';
            }
            
            
            
            function hls700_credit_modify_exit() {
                // var con_record = $('hls700_credit_modify_result_ds').getAll();
                // for (var i = 0;i < con_record.length;i++) {
                    // if (con_record[i].dirty == true) {
                        // Aurora.showMessage('提示', '界面数据已更改，请先保存');
                        // return;
                    // }
                // }
                $('bp_credit_modify_window').close();
            }
            
            
            function hls700_credit_modify_save() {
                debugger;
                var ds = $('hls700_credit_modify_result_ds');
                var records = ds.getAll();
                if (ds.validate()) {
                    var param_list = [];
                    var param = {};
                    for (var i = 0;i < records.length;i++) {
                        param = {
                            'assign_id': records[i].get('assign_id'),
                            'bp_credit_hd_id': ${/parameter/@bp_credit_hd_id},
                            'bp_id': records[i].get('bp_id'),
                            'credit_date_from': records[i].get('credit_date_from'),
                            'credit_date_to': records[i].get('credit_date_to'),
                            'enable_flag': records[i].get('enable_flag'),
                            '_status': 'update'
                        };
                        param_list.push(param);
                    }
                    Aurora.Masker.mask(Ext.getBody(), '${l:HLS.EXECUTING}');
                    Aurora.request({
                        url: $('hls700_credit_modify_update_link').getUrl(),
                        para: param_list,
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
                            Aurora.SideBar.show({
                                msg: '保存成功',
                                duration: 2000
                            });
                            $('hls700_credit_modify_result_ds').query();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="hls700_credit_detail_query_ds"/>
            <a:dataSet id="hls700_credit_modify_result_ds" autoPageSize="true" autoQuery="true" fetchAll="true" model="hls.HLS700.hls_bp_master_credit_modify" queryUrl="${/request/@context_path}/autocrud/hls.HLS700.hls_bp_master_credit_modify/query?bp_credit_hd_id=${/parameter/@bp_credit_hd_id}" selectable="true" selectionModel="single">
                <a:fields>
                    <a:field name="bp_name" lovHeight="500" lovService="hls.HLS700.hls700_bp_master_lov" lovWidth="700" required="true" title="商业伙伴选择">
                        <a:mapping>
                            <a:map from="bp_id" to="bp_id"/>
                            <a:map from="bp_code" to="bp_code"/>
                            <a:map from="bp_name" to="bp_name"/>
                            <a:map from="bp_category_n" to="bp_category_n"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="credit_date_from"/>
                    <a:field name="credit_date_to"/>
                    <a:field name="enable_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                </a:fields>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:screenTitle/>
                <a:gridButton click="hls700_credit_modify_add" text="HLS.NEW"/>
                <a:gridButton click="hls700_credit_modify_save" text="HLS.SAVE"/>
                <a:gridButton click="hls700_credit_modify_exit" text="HLS.EXIT"/>
            </a:screenTopToolbar>
            <a:grid id="hls700_credit_modify_grid_ds" bindTarget="hls700_credit_modify_result_ds" marginHeight="240" marginWidth="60" navBar="true">
                <a:columns>
                    <a:column name="bp_name" editor="creditDs_grid_detail_editor_lov" prompt="商业伙伴名称" width="280"/>
                    <!--  <a:column name="credit_total_amount" align="right" editor="creditDs_grid_modify_editor_tx" prompt="授信总额度" width="150"/> -->
                    <a:column name="credit_date_from" editor="creditDs_grid_modify_editor_dp" prompt="授信期限从" renderer="Aurora.formatDate" width="120"/>
                    <a:column name="credit_date_to" editor="creditDs_grid_modify_editor_dp" prompt="授信期限到" renderer="Aurora.formatDate" width="120"/>
                    <!-- <a:column name="open_amount" align="right" editor="creditDs_grid_modify_editor_tx" prompt="开额额度"/> -->
                    <a:column name="enable_flag" editor="creditDs_grid_detail_editor_cb" prompt="启用标志"/>
                </a:columns>
                <a:editors>
                    <a:currencyField id="creditDs_grid_modify_editor_tx"/>
                    <a:datePicker id="creditDs_grid_modify_editor_dp"/>
                    <a:lov id="creditDs_grid_detail_editor_lov"/>
                    <a:checkBox id="creditDs_grid_detail_editor_cb"/>
                </a:editors>
            </a:grid>
        </a:screenBody>
    </a:view>
</a:screen>
