<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: zhuxianfei
    $Date: 2017年11月23日 下午1:34:27  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure/>
    <a:view>
        <!-- <a:link id="bp_credit_details_window" url="${/request/@context_path}/modules/cont/CON403/con403_contract_credit_details.screen"/> -->
        <a:link id="hls700_credit_ln_update_link" model="hls.HLS700.hls_bp_master_credit_detail" modelaction="batch_update"/>
        <a:link id="hls700_credit_ln_delete_link" model="hls.HLS700.hls700_bp_master_credit_limit" modelaction="execute"/>
        <script><![CDATA[
            //集团的话查询出所有旗下单店的信息
            Aurora.onReady(function() {
                var parent_flag = '${/parameter/@parent_flag}';
                if (parent_flag == 'Y') {
                    var url = "${/request/@context_path}/autocrud/hls.HLS700.hls_parent_bp_credit_useinfo/query?bp_id=${/parameter/@bp_id}";
                    $('hls700_credit_useinfo_result_ds').setQueryUrl(url);
            
                }
            });
            
            function hls700_credit_detail_add() {
                $('hls700_credit_detail_grid_ds').showEditorByRecord($('hls700_credit_detail_result_ds').create());
            
            }
            
            function hls700_credit_detail__query() {
                $('hls700_credit_detail_result_ds').query();
            }
            
            
            // function hls700_credit_detail_render(value, record, name) {
            
            // return '<a href="javascript:hls700_grid_update(' + record.get('bp_credit_hd_id') + ')">分配</a>';
            // }
            
            function del_clear() {
                $('hls700_credit_detail_grid_ds').clear();
            }
            
            function credit_detail_exit() {
                // var con_record = $('hls700_credit_detail_result_ds').getAll();
                // for (var i = 0;i < con_record.length;i++) {
                // if (con_record[i].dirty == true) {
                // Aurora.showMessage('提示', '界面数据已更改，请先保存');
                // return;
                // }
                // }
                $('bp_credit_details_window').close();
            }
            
            //修改输入模式为仅新增
            
            function hls700_credit_detail_result_load(ds) {
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var record = records[i];
                    record.getField('credit_total_amount').setRequired(false);
                    record.getField('credit_total_amount').setReadOnly(true);
                    record.getField('credit_date_from').setRequired(false);
                    record.getField('credit_date_from').setReadOnly(true);
                    record.getField('credit_date_to').setRequired(false);
                    record.getField('credit_date_to').setReadOnly(true);
                }
                $('hls700_save_btn').enable();
            }
            
            function hls700_credit_detail_save() {
            
                Aurora.showConfirm('${l:HLS.PROMPT}', '您确认保存吗？', function() {
                    $('hls700_save_btn').disable();
                    Aurora.Masker.mask(Ext.getBody(), '${l:HLS.EXECUTING}');
                    var ds = $('hls700_credit_detail_result_ds');
                    var records = ds.getAll();
                    if (ds.validate()) {
                        var param_list = [];
                        var param = {};
                        var enable_num = 0; //启用数量
                        var credit_total_amount = 0;
                        for (var i = 0;i < records.length;i++) {
                            if (records[i].get('enable_flag') == 'Y') {
                                credit_total_amount = records[i].get('credit_total_amount');
                                enable_num = enable_num + 1;
                            } else if (records[i].get('enable_flag') == 'P') { //暂挂
                                credit_total_amount = records[i].get('credit_total_amount');
                            }
                            param = {
                                'bp_credit_line_id': records[i].get('bp_credit_line_id'),
                                // 'bp_credit_hd_id': ${/parameter/@bp_credit_hd_id},
                                'bp_id': ${/parameter/@bp_id},
                                'credit_total_amount': records[i].get('credit_total_amount'),
                                'credit_number': records[i].get('credit_number'),
                                'credit_date_from': records[i].get('credit_date_from'),
                                'credit_date_to': records[i].get('credit_date_to'),
                                'enable_flag': records[i].get('enable_flag'),
                                '_status': 'update'
                            };
                            param_list.push(param);
                        }
            
                        if (enable_num > 1) {
                            Aurora.showErrorMessage('${l:PROMPT.ERROR}', '额度明细只能存在一个生效的！', function() {}, 400, 150);
                            $('hls700_save_btn').enable();
                            Aurora.Masker.unmask(Ext.getBody());
                            return;
                        } else {
                            var use_records = $('hls700_credit_useinfo_result_ds').getAll();
                            var sum_amount = 0;
                            for (var j = 0;j < use_records.length;j++) {
                                sum_amount = plus(sum_amount, use_records[j].get('rm_amount'));
                            }
                            if (credit_total_amount < sum_amount) {
                                Aurora.showErrorMessage('${l:PROMPT.ERROR}', '授信总额度不可小于已使用额度！', function() {}, 400, 150);
                                $('hls700_save_btn').enable();
                                Aurora.Masker.unmask(Ext.getBody());
                                return;
                            }
                        }
            
            
                        Aurora.request({
                            url: $('hls700_credit_ln_update_link').getUrl(),
                            para: param_list,
                            success: function(res) {
                                Aurora.SideBar.show({
                                    msg: '保存成功',
                                    duration: 2000
                                });
                                Aurora.Masker.unmask(Ext.getBody());
                                $('hls700_credit_detail_result_ds').query();
                            },
                            failure: function() {
                                $('hls700_save_btn').enable();
                                Aurora.Masker.unmask(Ext.getBody());
                            },
                            error: function() {
                                $('hls700_save_btn').enable();
                                Aurora.Masker.unmask(Ext.getBody());
                            },
                            scope: this
                        });
                    }
                }, null);
            }
            
            function credit_detail_delete() {
                var ds = $('hls700_credit_detail_result_ds');
                var records = ds.getSelected();
                if (ds.validate()) {
                    var record = records[0];
                    Aurora.Masker.mask(Ext.getBody(), '${l:HLS.EXECUTING}');
                    Aurora.request({
                        url: $('hls700_credit_ln_delete_link').getUrl(),
                        para: {
                            bp_credit_line_id: record.get('bp_credit_line_id')
                        },
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
            
                            $('hls700_credit_detail_result_ds').query();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }
            }
            
            function enable_flag_desc_function(record, name) {
                if (record.isNew) {
                    if (name == 'enable_flag_desc') {
                        return 'creditDs_grid_detail_editor_cbb';
                    }
                } else {
                    if (name == 'enable_flag_desc') {
                        if (record.get('enable_flag') == 'N') {
                            return '';
                        } else {
                            return 'creditDs_grid_detail_editor_cbb';
            
                        }
                    }
                }
                return '';
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="hls700_credit_detail_query_ds"/>
            <a:dataSet id="enable_flag_ds" lookupCode="HLS700_ENABLED_FLAG"/>
            <a:dataSet id="hls700_credit_detail_result_ds" autoPageSize="true" autoQuery="true" fetchAll="true" model="hls.HLS700.hls_bp_master_credit_detail" queryUrl="${/request/@context_path}/autocrud/hls.HLS700.hls_bp_master_credit_detail/query?bp_id=${/parameter/@bp_id}" selectable="true" selectionModel="single">
                <a:fields>
                    <!--   <a:field name="bp_name" lovHeight="500" defaultValue="31483"  lovService="hls.HLS700.hls700_bp_master_lov" lovWidth="700" required="true" title="商业伙伴选择">
                        <a:mapping>
                            <a:map from="bp_id" to="bp_id"/>
                            <a:map from="bp_code" to="bp_code"/>
                            <a:map from="bp_name" to="bp_name"/>
                            <a:map from="bp_category_n" to="bp_category_n"/>
                        </a:mapping>
                    </a:field> -->
                    <a:field name="bp_name" defaultValue="${/parameter/@bp_name}" readOnly="true"/>
                    <a:field name="credit_total_amount" required="true"/>
                    <a:field name="open_amount"/>
                    <a:field name="credit_date_from" required="true"/>
                    <a:field name="credit_date_to" required="true"/>
                    <a:field name="enable_flag" defaultValue="Y" required="true"/>
                    <a:field name="enable_flag_desc" defaultValue="生效" displayField="code_value_name" options="enable_flag_ds" required="true" returnField="enable_flag" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="hls700_credit_detail_result_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="hls700_credit_useinfo_result_ds" autoPageSize="true" autoQuery="true" model="hls.HLS700.hls_bp_master_credit_useinfo" queryUrl="${/request/@context_path}/autocrud/hls.HLS700.hls_bp_master_credit_useinfo/query?bp_id=${/parameter/@bp_id}" selectable="true" selectionModel="single"/>
            <a:dataSet id="hls700_credit_used_detail_result_ds" autoPageSize="true" autoQuery="true" model="hls.HLS700.hls_bp_master_credit_detail"/>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:screenTitle/>
                <a:gridButton click="hls700_credit_detail_add" text="HLS.NEW"/>
                <a:gridButton id="hls700_save_btn" click="hls700_credit_detail_save" text="HLS.SAVE"/>
                <a:gridButton click="credit_detail_exit" text="HLS.EXIT"/>
                <!-- <a:gridButton click="credit_detail_delete" text="HLS.DELETE"/> -->
            </a:screenTopToolbar>
            <a:tabPanel marginHeight="200" marginWidth="30">
                <a:tabs>
                    <a:tab prompt="额度明细" width="110">
                        <a:grid id="hls700_credit_detail_grid_ds" bindTarget="hls700_credit_detail_result_ds" marginHeight="230" marginWidth="60" navBar="true">
                            <a:columns>
                                <a:column name="bp_name" editor="creditDs_grid_detail_editor_tf" prompt="商业伙伴名称" width="280"/>
                                <a:column name="credit_total_amount" align="right" editor="creditDs_grid_detail_editor_tx" prompt="授信总额度" renderer="Aurora.formatMoney" width="180"/>
                                <!-- <a:column name="open_amount" align="right" editor="creditDs_grid_detail_editor_tx" prompt="开额额度" renderer="Aurora.formatMoney" width="180"/> -->
                                <a:column name="credit_date_from" align="center" editor="creditDs_grid_detail_editor_dp" prompt="授信期限从" renderer="Aurora.formatDate" width="150"/>
                                <a:column name="credit_date_to" align="center" editor="creditDs_grid_detail_editor_dp" prompt="授信期限到" renderer="Aurora.formatDate" width="150"/>
                                <a:column name="enable_flag_desc" editorFunction="enable_flag_desc_function" prompt="额度状态"/>
                            </a:columns>
                            <a:editors>
                                <!--  <a:currencyField id="creditDs_grid_detail_editor_tx"/> -->
                                <a:numberField id="creditDs_grid_detail_editor_tx"/>
                                <a:datePicker id="creditDs_grid_detail_editor_dp"/>
                                <a:lov id="creditDs_grid_detail_editor_lov"/>
                                <a:checkBox id="creditDs_grid_detail_editor_cb"/>
                                <a:textField id="creditDs_grid_detail_editor_tf"/>
                                <a:comboBox id="creditDs_grid_detail_editor_cbb"/>
                            </a:editors>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="额度使用详情" width="110">
                        <a:grid id="hls700_credit_detail_grid_ds_02" bindTarget="hls700_credit_useinfo_result_ds" marginHeight="230" marginWidth="60" navBar="true">
                            <a:columns>
                                <a:column name="project_number" align="center" prompt="库融申请编号" width="150"/>
                                <a:column name="business_type_n" align="center" prompt="业务类型" width="120"/>
                                <a:column name="bp_name" align="center" prompt="经销商名称" width="280"/>
                                <a:column name="project_status_n" align="center" prompt="库融申请状态" width="120"/>
                                <a:column name="finance_amount" align="right" prompt="投放额度" renderer="Aurora.formatMoney" width="150"/>
                                <a:column name="rp_amount" align="right" prompt="释放额度" renderer="Aurora.formatMoney" width="150"/>
                                <a:column name="rm_amount" align="right" prompt="占用额度" renderer="Aurora.formatMoney" width="150"/>
                                <!-- <a:column name="lease_start_date" align="center" prompt="放款时间" renderer="Aurora.formatDate"/> -->
                            </a:columns>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
        </a:screenBody>
    </a:view>
</a:screen>
