<?xml version="1.0" encoding="UTF-8"?>
<a:service xmlns:ns1="aurora.application.action" xmlns:p="uncertain.proc" xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <s:server-script import="app/app_login_check.js"><![CDATA[
            function lov_query() {
                var lov_list_details;
                try {
                    var lov_list_bm = $bm('app.lov.app_con_query');
                    if (!$ctx.parameter.creation_date) {
                        $ctx.parameter.creation_date = null;
                    }
                    if (!$ctx.parameter.project_number) {
                        $ctx.parameter.project_number = null;
                    }
                    if (!$ctx.parameter.contract_number) {
                        $ctx.parameter.contract_number = null;
                    }
                    if (!$ctx.parameter.bp_id_tenant_n) {
                        $ctx.parameter.bp_id_tenant_n = null;
                    }
                    if (!$ctx.parameter.contract_status) {
                        $ctx.parameter.contract_status = null;
                    }
                    var lov_list_map = lov_list_bm.queryAsMap({
                        project_number: $ctx.parameter.project_number,
                        contract_number: $ctx.parameter.contract_number,
                        bp_id_tenant_n: $ctx.parameter.bp_id_tenant_n,
                        contract_status: $ctx.parameter.contract_status,
                        creation_date: $ctx.parameter.creation_date,
                        user_id: $ctx.parameter.user_id
                    });
                    lov_list_details = lov_list_map.getChildren();
                    $ctx.parameter.return_status = 'S';
                    $ctx.parameter.return_message = '执行成功';
                } catch (e) {
                    $ctx.success = "true";
                    $ctx.parameter.return_status = 'E';
                    $ctx.parameter.return_message = String(e);
                }
            
            
                var result = {
                    result: $ctx.parameter.return_status,
                    message: $ctx.parameter.return_message,
                    con_list: []
                };
                var con_list = result.con_list;
                if (lov_list_details) {
                    for (var i = 0;i < lov_list_details.length;i++) {
                        var lov_list_detail = lov_list_details[i];
                        con_list.push({
                            "project_number": lov_list_detail.project_number,
                            "contract_number": lov_list_detail.contract_number,
                            "bp_id_tenant_n": lov_list_detail.bp_id_tenant_n,
                            "contract_status_n": lov_list_detail.contract_status_n,
                            "contract_id": String(lov_list_detail.contract_id),
                            "creation_date": String(lov_list_detail.creation_date)
                        });
                    }
                }
            
                $ctx.parameter.json = JSON.stringify(result);
            }
            if ($ctx.parameter.return_status != 'E'&& $ctx.parameter.return_status != 'TIMEOUT') {
                lov_query();
            }
        ]]></s:server-script>
    </a:init-procedure>
    <a:service-output output="/parameter/@json"/>
</a:service>
