<?xml version="1.0" encoding="UTF-8"?>
<!--
    2014-10-27  create bu xuls for 变更申请-支付期调整  维护
    
 -->
<a:screen xmlns:s="aurora.plugin.script" xmlns:a="http://www.aurora-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure/>
    <a:view>
        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
        <a:link id="con_contract_modify_link" url="${/request/@context_path}/modules/cont/CON505/con_contract_modify.screen"/>
        <a:link id="con_contract_change_link" url="${/request/@context_path}/modules/cont/CON731/hls_con_contract_change_detail.screen"/>
        <a:link id="hls_ccr_modify_wfl_msg_link" url="${/request/@context_path}/modules/cont/CON732/hls_ccr_modify_wfl_msg_detail.screen"/>
        <a:link id="con_contract_change_req_link" url="${/request/@context_path}/modules/cont/CON701/con_contract_et_print.svc"/>
        <script><![CDATA[
            var new_recs = []; //任务数组
            var total_index = 0;
            var current_index = 0;
            var file_path = '${/parameter/@file_path}';
            var download_arr = [];
            
            
             function open_contract_win(ds_id, record_id) {
                var record = $(ds_id).findById(record_id);
                var param = record.data;
                param['function_code'] = 'CON301';
                param['function_usage'] = 'QUERY'; 
                param['maintain_type'] = 'UPDATE';
                param['url_title'] = '${l:CON301.CONTRACT_DETAIL}';
                hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'con_contract_modify_link', null);
            }
            
            function open_change_detail(ds_id, record_id) {
                var record = $(ds_id).findById(record_id);
                var param = record.data;
                param['change_req_id'] = record.get('contract_id');
                param['contract_id'] = record.get('contract_id');
                param['function_usage'] = 'MODIFY';
                param['maintain_type'] = 'UPDATE';
                if (record.get('ccr_document_type') == 'CCHAG') {
                    param['function_code'] = 'CON732D';
                    param['url_title'] = '变更申请-报价信息变更 ';
                } else if (record.get('ccr_document_type') == 'CGUTCHAG') {
                    param['function_code'] = 'CON732D_GUAR';
                    param['url_title'] = '变更申请-新增商业伙伴';
                } else {
                    param['function_code'] = 'CON732D_BASIC';
                    param['url_title'] = '变更申请-常规信息调整 ';
                }
                param['document_type'] = record.get('ccr_document_type');
                hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'con_contract_change_link', ds_id);
            }
            
            //工作流审批记录
            
            function open_wfl_msg_detail(ds_id, record_id) {
                var record = $(ds_id).findById(record_id);
                var req_wfl_instance_id = record.get('req_wfl_instance_id');
                new Aurora.Window({
                    id: 'open_wfl_msg_win',
                    url: $('hls_ccr_modify_wfl_msg_link').getUrl(),
                    params: {
                        instance_id: req_wfl_instance_id,
                        winId: 'open_wfl_msg_win'
                    },
                    width: '800',
                    height: '400'
                });
            }
            
            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
                if (name == 'contract_number' && value) {
                    return '<a href="javascript:open_contract_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
                }
                /* else if (name == 'change_req_number' && value) {
                 return '<a href="javascript:open_change_detail(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
                 } else if (name == 'wfl_msg_detail') {
                 return '<a href="javascript:open_wfl_msg_detail(\'' + record.ds.id + '\',\'' + record.id + '\')">审批记录</a>';
                 } */
                return value;
            };
            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                var prj_project_result_ds = $(ds_id);
                var records = prj_project_result_ds.getSelected();
            
                if (records.length != 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:HLS.SELECT_RECORD}');
                    return;
                }
                var record = records[0];
                var param = record.data;
                var req_status = record.get('req_status');
                param['change_req_id'] = record.get('contract_id');
                param['contract_id'] = record.get('contract_id');
                param['function_code'] = 'CON732D';
                param['function_usage'] = 'MODIFY';
                param['maintain_type'] = 'UPDATE';
            
                if (record.get('ccr_document_type') == 'PAYCARD' && (req_status == 'REJECT' || req_status == 'CANCEL' || req_status == 'APPROVED' || req_status == 'APPROVING')) {
                    param['function_code'] = 'CON732Q';
                    param['function_usage'] = 'QUERY';
                    param['url_title'] = '变更申请-还款卡变更查询 ';
                } else if (record.get('ccr_document_type') == 'BASICHAG' && (req_status == 'REJECT' || req_status == 'CANCEL' || req_status == 'APPROVED' || req_status == 'APPROVING')) {
                    param['function_code'] = 'CON702E';
                    param['function_usage'] = 'QUERY';
                    param['url_title'] = '变更申请-常规信息查询 ';
                } else if (record.get('ccr_document_type') == 'PAYCARD') {
                    param['function_code'] = 'CON732D';
                    param['url_title'] = '变更申请-还款卡变更 ';
                } else {
                    param['function_code'] = 'CON732D_BASIC';
                    param['url_title'] = '变更申请-常规信息调整 ';
                }
                param['document_type'] = record.get('ccr_document_type');
                hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'con_contract_change_link', ds_id);
            };
            
            //变更申请打印单
            window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                var xmlTemp = '';
                var fileName = '';
                xmlTemp = 'con_contract_change_req_apply.xml';
                fileName = '变更申请单.pdf';
                var url = $('con_contract_change_req_link').getUrl() + '?xmlTemp=' + xmlTemp + '&fileName=' + fileName;
                window.open(url);
            };
            
            window['${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) { //查询权限
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                if (ds == $(ds_id)) {
                    aut_authority_list_validate_query(ds, qpara);
                }
            };
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
        <a:screen-include screen="modules/cont/CON500/con_contract_authority_list_validate.screen?document_category=CHANGE_REQUEST&amp;function_code=CON732"/>
    </a:view>
</a:screen>
