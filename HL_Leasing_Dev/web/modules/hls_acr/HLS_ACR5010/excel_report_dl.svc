<?xml version="1.0" encoding="UTF-8"?>
<a:service xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <s:server-script><![CDATA[
            importPackage(java.util.zip);
            importPackage(java.io);
            importPackage(org.apache.tools.zip);
            
            //table_name ,table_pk_value 为附件批次标识,这仅是默认值例子,正式使用请注释掉
            //可以通过excel_report_dl.svc?table_name=olf&table_pk_value=a的方式传参
            //$ctx.parameter.table_name = '${/parameter/@table_name}';
            //$ctx.parameter.table_pk_value = '${/parameter/@table_pk_value}';
            
            function writeFile(zos, fn, fp) {
                var ze = new ZipEntry(fn);
               // zos.setEncoding("UTF-8");//如果是org.apache.tools.zip需要追加字符集
                zos.putNextEntry(ze);
                var fis = new FileInputStream(fp);
                var b = new java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024 * 64);
                var len = -1;
                while ((len = fis.read(b)) != -1) {
                    zos.write(b, 0, len);
                }
                fis.close();
            }
            
            function get_time() {
                var myDate = new Date();
                var y = myDate.getFullYear();
                var m = myDate.getMonth() + 1;
                var d = myDate.getDate();
                if (m < 10) {
                    m = '0' + m;
                }
                if (d < 10) {
                    d = '0' + d;
                }
                return y + '-' + m + '-' + d;
            }
            $ctx["__request_type__"] = 'file'; //to indicate this request is not a JSON_REQUEST
            var resp = $ctx['_instance.javax.servlet.http.HttpServletResponse'];
            resp.setHeader("Pragma", "No-cache");
            resp.setHeader("Cache-Control", "no-cache, must-revalidate");
            var filename = 'batch_dowload_' + get_time() + ".zip"
            resp.setHeader("Content-disposition", "attachment; filename=" + filename);
            resp.setDateHeader("Expires", 0);
            resp.setContentType("application/x-msdownload");
            var zos = new ZipOutputStream(resp.getOutputStream());
           
            try {
                var attachment_for_excel_dl = $bm('hls_acr.hls_acr5010.attachment_for_excel_dl');
                var result = attachment_for_excel_dl.queryAsMap();
                var arr = result.getChildren();
                for (var i = 0;i < arr.length;i++) {
                    var f = arr[i];
                  //  println('f.file_name:'+f.file_name+',f.file_path:'+f.file_path);
                    if (f.file_path) {
                        var　file_name=f.file_name;
                        writeFile(zos, file_name, f.file_path);
                    }
                }
            } catch (e) {
                var logger = $logger("server-script");
                logger.severe(e.message)
            }
            zos.close();
        ]]></s:server-script>
    </a:init-procedure>
</a:service>
