<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: dingzhichao 2855  
    $Date: 2011-6-13 上午11:18:10  
    $Revision: 1.0  
    $Purpose:银行代扣数控导入
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure>
        <model-execute autoCount="false" model="db.hls_acr_ebanking_pkg.delete_ebank" rootpath="reload_tmp_record"/>
        <a:model-query autoCount="true" defaultWhereClause="enabled_flag = &apos;Y&apos;" fetchall="true" model="gld.gld_currency" queryOrderBy="currency_code" rootpath="currency_list"/>
        <a:model-query autoCount="false" fetchAll="true" model="hls_acr.hls_acr5010.hls_acr_ebank_output_for_init" rootPath="hls_acr_ebank_output_for_init_list"/>
    </a:init-procedure>
    <a:view package="aurora.ui.std" template="default">
        <a:link id="hls_acr_ebank_input_link_2" url="${/request/@context_path}/modules/hls_acr/HLS_ACR5030/hls_acr_ebank_input.screen"/>
        <a:link id="hls_sap_certificate_detail_link_12" url="${/request/@context_path}/modules/sap/hls_sap_certificate_detail.screen"/>
        <a:link id="hls_acr_ebank_input_link_1" url="${/request/@context_path}/modules/hls_acr/HLS_ACR5030/hls_acr_ebank_input.svc"/>
        <a:link id="run_ebank_input_link" model="hls_acr_ebanking_pkg.run_ebank_input" modelaction="execute"/>
        <script><![CDATA[
        	Ext.Ajax.timeout = 3000000;
        	
            var wd;
            
            function attachment_up() {
                var p_sourcetype = 'hls_acr_ebank_input';
                var p_pkvalue = '${/session/@session_id}';
            
                //url ='${/request/@context_path}/modules/hls_prj/'+"hls_prj_customer_legal_view_employee.screen?customer_id="+id;
                var url = '${/request/@context_path}/hls_upload_for_attachment_db_view.screen?sourcetype=' + p_sourcetype + '&' + 'pkvalue=' + p_pkvalue;
                //window.open(url);
                //new Aurora.Window({id:'attachment_up_window', url:'${/request/@context_path}/hls_upload_for_attachment_view.screen?sourcetype='+p_sourcetype+'&'+'pkvalue='+p_pkvalue, title:'附件上传', height:350,width:850});
                wd = new Aurora.Window({
                    id: 'attachment_up_window',
                    url: url,
                    title: '附件上传',
                    height: 350,
                    width: 850
                });
            }
            
            function generate_input_data() {
                var record = $('hls_acr_ebank_input_hds_ds').getCurrentRecord();
                var collection_date = record.get("collection_date");
                var collection_account_id = record.get("collection_account_id");
                var payment_method = record.get("payment_method");
                var currency_code = record.get("currency_code");
                var bank_doc_number = record.get('bank_doc_number');
                var description = record.get("description");
                if (!collection_date) {
                    Aurora.showErrorMessage("错误信息", " 收款日期不能为空");
                    return false;
                }
                if (!collection_account_id) {
                    Aurora.showErrorMessage("错误信息", " 收款账号不能为空");
                    return false;
                }
                if (!payment_method) {
                    Aurora.showErrorMessage("错误信息", " 租金支付方式不能为空");
                    return false;
                }
                if (!currency_code) {
                    Aurora.showErrorMessage("错误信息", " 币种不能为空");
                    return false;
                }
                if (collection_date && collection_account_id && payment_method && currency_code) {
                    Aurora.request({
                        url: '${/request/@context_path}/autocrud/db.hls_acr_ebanking_pkg.run_ebank_input/execute'/*$('run_ebank_input_link').getUrl()*/,
                        para: {
                            collection_date: collection_date,
                            collection_account_id: collection_account_id,
                            payment_method: payment_method,
                            currency_code: currency_code,
                            bank_doc_number: bank_doc_number,
                            description: description
                        },
                        success: function(args) {
                            //Aurora.showMessage("提示信息","代扣信息生成成功",return_back);
                            $('hls_acr_ebank_process_temp_v_ds').query();
                        },
                        scope: this
                    });
                }
            
            }
            
            function commit_data() {
                var hds_ds = $('hls_acr_ebank_input_hds_ds');
                var lns_ds = $('hls_acr_ebank_process_temp_v_ds');
                var length = lns_ds.getAll().length;
                var data = [];
                var data1 = $('hls_acr_ebank_process_temp_v_ds').getJsonData();
                data = hds_ds.getJsonData(false)[0] || [];
                data['lns'] = data1;
                if (hds_ds.validate() && length > 0) {
            
                    var createConfirm = Aurora.showConfirm('操作确认', '是否要提交数据', function() {
                        createConfirm.close();
                        Aurora.request({
                            url: 'hls_acr_ebank_input.svc'/*$('hls_acr_ebank_input_link_1').getUrl()*/,
                            para: data,
                            success: function(args) {
                            	var batch_flag = args.result.batch_flag;
	                            var batch_id = args.result.batch_id;
	                            if (batch_flag == 'Y') {
	                                win = new Aurora.Window({
	                                    id: 'sap_certificate_detail',
	                                    url: '${/request/@context_path}/modules/sap/hls_sap_certificate_detail.screen'/*$('hls_sap_certificate_detail_link_12').getUrl()*/+'?batch_id=' + batch_id,
	                                    title: 'SAP接口凭证信息',
	                                    height: 550,
	                                    width: 800
	                                });
	                                win.addListener('close',function(){
						                Aurora.showMessage('提示信息', '操作成功', close_window);
						            });
	                            }else{
	                                Aurora.showMessage('提示信息', '操作成功', close_window);
	                            }
                            },
                            scope: this
                        });
                        
                    }, function() {
                        createConfirm.close();
                    }, null, null);
                }
            }
            
            function close_window() {
                window.location.href = 'hls_acr_ebank_input.screen'/*$('hls_acr_ebank_input_link_2').getUrl()*/;
            }
            
            function load_date(ds, record, i) {
                var date = new Date();
                record.set("collection_date", date);
            }
            
            function update_fields(dataSet, record, name, value, old_value) {
                if (name == "collection_date") {
                    record.set("collection_account_number", null);
                    record.set("payment_method_disp", null);
                    record.set("currency_name", null);
                    record.set("bank_doc_number", null);
                    record.set("description", null);
                }
                
                /**
                 if (name == "payment_method_disp" && value) {
                 if (old_value && value) {
                 record.set("collection_account_number", null);
                 record.set("collection_date", null);
                 record.set("currency_name", null);
                 record.set("bank_doc_number", null);
                 record.set("description", null);
                 }
                 }
                 if (name == "currency_name") {
                 if (old_value && value) {
                 record.set("collection_account_number", null);
                 record.set("collection_date", null);
                 record.set("payment_method_disp", null);
                 record.set("bank_doc_number", null);
                 record.set("description", null);
                 }
                 }*/
            }
            
            function summaryRenderer(datas, name) {
            
                var sum = 0;
                var sum1 = 0
                var record;
                var credit_balance_vl;
                var credit_balance;
                var write_off_amount_vl
                var write_off_amount
                for (var i = 0;i < datas.length;i++) {
                    record = datas[i];
                    if (name == "credit_balance") {
                        credit_balance_vl = record.get("credit_balance");
                        credit_balance = parseFloat(credit_balance_vl);
                        if (!isNaN(credit_balance)) {
                            sum += credit_balance;
                        }
                    }
                    if (name == "write_off_amount") {
                        write_off_amount_vl = record.get("write_off_amount");
                        write_off_amount = parseFloat(write_off_amount_vl);
                        if (!isNaN(write_off_amount)) {
                            sum += write_off_amount;
                        }
                    }
                }
                sum1 = sum;
                sum = 0;
                if (name == "credit_balance") {
            
                    return '<font color="red">合计：' + Aurora.formatNumber(sum1, 2) + '</font>';
                }
                if (name == "write_off_amount") {
                    return '<font color="red">' + Aurora.formatNumber(sum1, 2) + '</font>';
                }
            }
            
             function numberRenderer(value, record, name){
               return Aurora.formatNumber(value,2);
            }
            ]]></script>
        <a:dataSets>
            <!--收款账号-->
            <a:dataSet id="hls_company_account_ds" loadData="true" model="hls_acr.HLS_ACR5030.hls_acr_company_accounts_for_select"/>
            <!--租金支付方式-->
            <a:dataSet id="hls_acr_payment_method_ds">
                <a:datas dataSource="/model/hls_acr_ebank_output_for_init_list"/>
            </a:dataSet>
            <!--货币-->
            <a:dataSet id="hls_currency_ds">
                <a:datas dataSource="/model/currency_list"/>
            </a:dataSet>
            <a:dataSet id="collection_source_ds" loadData="true" model="hls_acr.hls_acr_collection_source_for_init">
                <a:fields>
                    <a:field name="collection_source" readOnly="true"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="hls_acr_ebank_process_temp_v_ds" autoCount="true" autoQuery="true" model="hls_acr.HLS_ACR5030.hls_acr_ebank_process_temp_v_for_query" queryUrl="${/request/@context_path}/autocrud/hls_acr.HLS_ACR5030.hls_acr_ebank_process_temp_v_for_query/query?ORDER_FIELD=sequence_no">
                <a:fields>
                    <a:field name="pre_payment_date" dataType="date"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="hls_acr_ebank_input_hds_ds" autoCreate="true">
                <a:fields>
                    <a:field name="transaction_hds_id"/>
                    <a:field name="collection_number" readOnly="true"/>
                    <a:field name="Verification_transaction_number" readOnly="true"/>
                    <a:field name="collection_date" required="true"/>
                    <a:field name="collection_account_id"/>
                    <a:field name="collection_account_number" displayField="bank_account_number" options="hls_company_account_ds" required="true" returnField="collection_account_id" valueField="hls_company_id"/>
                    <a:field name="payment_method"/>
                    <a:field name="payment_method_disp" displayField="code_value_name" options="hls_acr_payment_method_ds" required="true" returnField="payment_method" valueField="code_value"/>
                    <a:field name="currency_code"/>
                    <a:field name="currency_name" displayField="currency_name" options="hls_currency_ds" required="true" returnField="currency_code" valueField="currency_code"/>
                    <a:field name="bank_doc_number"/>
                    <a:field name="description"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="load_date"/>
                    <a:event name="update" handler="update_fields"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:form title="HLS_ACR_EBANK_INPUT.INPUT_RESULT">
                <a:vBox labelWidth="100" padding="0" width="800">
                    <a:hBox labelWidth="100" prompt="HLS_ACR_EBANK_INPUT.COLLECTION_SOURCE">
                        <a:textField name="collection_source" bindTarget="collection_source_ds" prompt="" width="150"/>
                        <a:comboBox name="collection_account_number" bindTarget="hls_acr_ebank_input_hds_ds" prompt="HLS_ACR_EBANK_INPUT.COLLECTION_BANK_NUMBER" width="150"/>
                        <a:datePicker name="collection_date" bindTarget="hls_acr_ebank_input_hds_ds" prompt="HLS_ACR_EBANK_INPUT.COLLECTION_DATE" width="150"/>
                    </a:hBox>
                    <a:hBox labelWidth="100" prompt="HLS_ACR_EBANK_INPUT.PAYMENT_METHOD">
                        <a:comboBox name="payment_method_disp" bindTarget="hls_acr_ebank_input_hds_ds" prompt="" width="150"/>
                        <a:comboBox name="currency_name" bindTarget="hls_acr_ebank_input_hds_ds" prompt="HLS_ACR_EBANK_INPUT.CURRENCY_NAME" width="150"/>
                        <a:textField name="bank_doc_number" bindTarget="hls_acr_ebank_input_hds_ds" prompt="HLS_ACR_EBANK_INPUT.BANK_DOC_NUMBER" width="150"/>
                    </a:hBox>
                    <a:hBox labelWidth="100" prompt="HLS_ACR_EBANK_INPUT.DESCRIPTION">
                        <a:textField name="description" bindTarget="hls_acr_ebank_input_hds_ds" prompt="" width="667"/>
                    </a:hBox>
                </a:vBox>
            </a:form>
            <a:hBox>
                <a:button click="attachment_up" text="PROMPT.IMPORT"/>
                <a:button click="generate_input_data" text="HLS_ACR_EBANK_INPUT.GENERATE_INPUT_DATA"/>
            </a:hBox>
            <a:form title="HLS_ACR_EBANK_INPUT.EBANK_DATA">
                <a:grid bindTarget="hls_acr_ebank_process_temp_v_ds" height="300" navBar="true" width="1030">
                    <a:columns>
                        <a:column name="sequence_no" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.SEQUENCE_NO" width="30"/>
                        <a:column name="customer_name" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.CUSTOMER_NAME" width="80"/>
                        <a:column name="credit_category_disp" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.CREDIT_CATEGORY" width="50"/>
                        <a:column name="contract_number" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.CONTRACT_NUMBER" width="130"/>
                        <a:column name="period_number" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.PERIOD_NUMBER" width="50"/>
                        <a:column name="pre_payment_date" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.PRE_PAYMENT_DATE" renderer="Aurora.formatDate" width="80"/>
                        <a:column name="credit_balance" footerRenderer="summaryRenderer" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.CREDIT_BALANCE" renderer="numberRenderer" width="100"/>
                        <a:column name="write_off_amount" footerRenderer="summaryRenderer" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.WRITE_OFF_AMOUNT" renderer="numberRenderer" width="80"/>
                        <a:column name="partner_account_number" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.PARTNER_ACCOUNT_NUMBER" width="120"/>
                        <a:column name="bank_account_name" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.BANK_ACCOUNT_NAME" width="100"/>
                        <a:column name="bank_account_number" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.BANK_ACCOUNT_NUMBER" width="100"/>
                        <a:column name="description" editor="description_tf" prompt="HLS_ACR_EBANK_PROCESS_TEMP_V.DESCRIPTION" width="100"/>
                    </a:columns>
                    <a:editors>
                        <a:textField id="description_tf"/>
                    </a:editors>
                </a:grid>
            </a:form>
            <a:hBox>
                <a:button click="commit_data" text="PROMPT.SUBMIT"/>
            </a:hBox>
        </a:screenBody>
    </a:view>
</a:screen>
