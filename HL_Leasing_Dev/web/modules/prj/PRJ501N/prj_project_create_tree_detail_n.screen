<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: gaoyang  
    $Date: 2013-6-24 下午03:23:39  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:c="aurora.application.action" xmlns:s="aurora.plugin.script" xmlns:a="http://www.aurora-framework.org/application" xmlns:p="uncertain.proc" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:view>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_prj500_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_prj500_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_change_rate_link_id" url="${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_change_rate.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_handle_query_link_id" url="${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_handle_query.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_handle_formula_link_id" url="${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_handle_formula.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_prj_project_statement_note_link_id" url="${/request/@context_path}/modules/prj/PRJ509/prj_project_statement_note.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_statement_prj_import_cashflow_forecast_link_id" url="${/request/@context_path}/modules/rsc/RSC304/rsc_fin_statement_prj_import_cashflow_forecast.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_hls_bp_master_dynamic_update_link_id" url="${/request/@context_path}/modules/hls/HLS213/hls_bp_master_dynamic_update.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_hls_bp_master_get_layout_code_link_id" model="hls.HLS213.hls_bp_master_get_layout_code" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_prj500_quote_link_id" url="${/request/@context_path}/modules/hls/HLS500/hls_fin_calc_quotation_header.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calc_quotation_header_link_id" url="${/request/@context_path}/modules/hls/HLS500/hls_fin_calc_quotation_header.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calculator_update_link_id" url="${/request/@context_path}/modules/hls/HLS500N/hls_fin_calculator_update_n.screen"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_doc_quotation_link_id" url="${/request/@context_path}/modules/hls/HLS500/hls_fin_doc_quotation.svc"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tree_code}_get_fin_statement_tmlt_id_link" model="prj.PRJ501.get_fin_statement_tmlt_id" modelaction="query"/>
        <!-- <link href="${/request/@context_path}/css/lightbox.css" rel="stylesheet" type="text/css"/>-->
        <!-- <script src="${/request/@context_path}/javascripts/lightbox.js"/>-->
		<link href="${/request/@context_path}/viewerjs/viewer.css" rel="stylesheet"/>
        <script src="${/request/@context_path}/viewerjs/viewer.js"/>
        <script src="${/request/@context_path}/viewerjs/viewer_tool.js"/>
        <script><![CDATA[
        	//Ext.ux.Lightbox.register('a[ref=img]',true);
        
            window['${/parameter/@layout_code}_on_layout_dynamic_form_add_and_load'] = function(ds, record) {
                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            };
            
            window['${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record, config_records) {
                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            };
            
            window['${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
                var ds_id = '${/parameter/@layout_code}_F_LEASE_ITEM_prj_project_lease_item_ds';
                if (ds.id == ds_id) {
                    if (name == 'price') {
                        record.set('total_amount', value * record.get('quantity'));
                    }
                    if (name == 'quantity') {
                        record.set('total_amount', value * record.get('price'));
                    }
                }
            };
            
            var specialColor = {
                form_render: 'red'
            };
            
            
            function in_renderer_name(name) {
                var names = {
                    'change_rate': true,
                    'fin_indicator': true,
                    'fin_statement': true,
                    'fin_statement_notes': true,
                    'cashflow_forecast': true,
                    'bp_info_link': true,
                    'psr_report_info_link': true,
                    'gua_psr_report_info_link': true,
                    'psr_target_info_link': true,
                    'gua_psr_target_info_link': true,
                    'psr_change_info_link': true,
                    'gua_psr_change_info_link': true,
                    'bp_statement_note': true
                };
                if (names[name]) {
                    return true;
                } else {
                    return false;
                }
            
            }
            
            
            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
                var link_function = '';
                window['${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
                if (name == 'attachment') {
                    link_function = '${/parameter/@layout_code}_prj500_cdd_attachtment_upload';
                    return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                } else if (name == 'quote') {
                    link_function = '${/parameter/@layout_code}_prj500_quote';
                    return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record + '\');">' + config_record.get('prompt') + '</a>';
                } else if (in_renderer_name(name)) {
                    link_function = '${/parameter/@layout_code}${/parameter/@tree_code}_form_renderer_window';
                    return '<a style="color:' + specialColor['form_render'] + '" href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');">' + config_record.get('prompt') + '</a>';
                } else if (name == 'attach_file_name') {
                    if (value != null) {
                        var link = '${/request/@context_path}/atm_download.svc?attachment_id=';
                        var str = value.split(';;');
                        var url = '';
                        for (var i = 0;i < str.length;i++) {
                            var temp = str[i].split('--');
                            if (!Aurora.isEmpty(temp[0])) {
                                // url = url + '<a ref="img" href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                    link_function = 'show_viewer_more';
                                    url = url + '<a href="javascript:window[\'' + link_function + '\'](\'' + link + '\',\'' + temp[1] + '\',\'' + temp[0] + '\',\'' + value + '\');">' + temp[0] + '</a>' + ',';
                            }
                        }
                        return url;
            
                    }
                }else if (name == 'batch_download') {
                    debugger;
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                    var project_id = $(ds_id).getAt(0).get('project_id');
                    return '<a href="javascript:batch_download(' + record.get('check_id') + ')">' + config_record.get('prompt') + '</a>';
                    //
                    //window.open(url);
                }
            };
            
            
            //行批量下载            
            function batch_download(check_id) {
                debugger;
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
                // var document_id = $(ds_id).getAt(0).get('project_id');
                var project_number = $(ds_id).getAt(0).get('project_number');
                var project_id = $(ds_id).getAt(0).get('project_id');
                var document_table = 'PRJ_PROJECT';
                url = '${/request/@context_path}/modules/prj/lease_atm_batch_dl.svc?document_table=' + document_table + '&document_id=' + project_id + '&check_id=' + check_id + '&doc_code=' + project_number + '&type=ZIP';
                window.open(url);
            }
            
            function prj_doc_get_layout_code(bm_url_link, param, win_url_link, list_ds) {
                lock_iframe_window();
                Aurora.request({
                    url: $(bm_url_link).getUrl(),
                    para: param,
                    success: function(res) {
                        $A.Masker.unmask(Ext.get(document.documentElement));
                        if (!res.result.layout_code) {
                            Aurora.showMessage('${l:PROMPT}', '${l:HLS.LAYOUT_CODE_IS_NULL}');
                            return;
                        }
                        param['layout_code'] = res.result.layout_code;
                        param['usage_type'] = res.result.usage_type;
                        param['winid'] = 'hls_doc_get_layout_code_winid';
                        param['calc_type'] = res.result.cond_para1;
            
                        var win = new Aurora.Window({
                            id: 'hls_doc_get_layout_code_winid',
                            params: param,
                            url: $(win_url_link).getUrl(),
                            title: param['url_title'] + '(' + res.result.layout_code + ')',
                            fullScreen: true,
                            draggable: true
                        });
                        win.on('close', function() {
                            if (list_ds) {
                                $(list_ds).query();
                            }
                        });
                    },
                    failure: function() {
                        $A.Masker.unmask(Ext.get(document.documentElement));
                    },
                    error: function() {
                        $A.Masker.unmask(Ext.get(document.documentElement));
                    },
                    scope: this
                });
            }
            
            window['${/parameter/@layout_code}${/parameter/@tree_code}_form_renderer_window'] = function(id, name) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('bp_id')) {
                    var url, url_title, open_win_flag, show_message;
                    if (name == 'change_rate') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_change_rate_link_id').getUrl();
                        url_title = '${l:PRJ501.RATE_OF_CHANGE_DETAILS_REPORT}';
                    } else if (name == 'fin_indicator') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_handle_formula_link_id').getUrl();
                        url_title = '${l:PRJ501.FINANCIAL_INDEX_DETAILS}';
                    } else if (name == 'fin_statement') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_handle_query_link_id').getUrl();
                        url_title = '${l:PRJ501.FINANCIAL_STATEMENT_ROWS}';
                    } else if (name == 'fin_statement_notes') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_prj_project_statement_note_link_id').getUrl();
                        url_title = '${l:PRJ501.NOTES_TO_THE_FINANCIAL_STATEMENTS_MAINTAINED}';
                    } else if (name == 'cashflow_forecast') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_rsc_fin_statement_prj_import_cashflow_forecast_link_id').getUrl();
                        url_title = '${l:RSC_FIN_STATEMENT_TMPLT_HDS.CASHFLOW_FORECAST}';
                    } else if (name == 'bp_info_link') {
                        url = '';
                        open_win_flag = 'Y';
                    } else if (name == 'psr_report_info_link' || name == 'gua_psr_report_info_link') {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}${/parameter/@tree_code}_get_fin_statement_tmlt_id_link').getUrl(),
                            para: {
                                bp_id: record.get('bp_id')
                            },
                            success: function(res) {
                                var fin_statement_templet_id = res.result.record['fin_statement_templet_id'];
                                var fin_count = res.result.record['fin_count'];
                                if (fin_count == 0) {
                                    if (name == 'psr_report_info_link') {
                                        show_message = '该承租人财务报表信息不存在！';
                                    } else if (name == 'gua_psr_report_info_link') {
                                        show_message = '该担保人财务报表信息不存在！';
                                    }
                                } else {
                                    url = '${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_handle_query.screen?fin_statement_templet_id=' + fin_statement_templet_id + '&amp;bp_id=' + record.get('bp_id');
                                    url_title = '${l:RSC_FIN_STATEMENT_TMPLT_HDS.FIN_STATEMENT_DETAIL}';
                                }
                            },
                            sync: true
                        });
                    } else if (name == 'psr_target_info_link' || name == 'gua_psr_target_info_link') {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}${/parameter/@tree_code}_get_fin_statement_tmlt_id_link').getUrl(),
                            para: {
                                bp_id: record.get('bp_id')
                            },
                            success: function(res) {
                                var fin_statement_templet_id = res.result.record['fin_statement_templet_id'];
                                var fin_count = res.result.record['fin_count'];
                                if (fin_count == 0) {
                                    if (name == 'psr_target_info_link') {
                                        show_message = '该承租人财务指标明细信息不存在！';
                                    } else if (name == 'gua_psr_target_info_link') {
                                        show_message = '该担保人财务指标明细信息不存在！';
                                    }
                                } else {
                                    url = '${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_handle_formula.screen?fin_statement_templet_id=' + fin_statement_templet_id + '&amp;bp_id=' + record.get('bp_id');
                                    url_title = '${l:RSC_FIN_INDICATOR_FORMULA.INDICATOR_DETAIL}';
                                }
                            },
                            sync: true
                        });
                    } else if (name == 'psr_change_info_link' || name == 'gua_psr_change_info_link') {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}${/parameter/@tree_code}_get_fin_statement_tmlt_id_link').getUrl(),
                            para: {
                                bp_id: record.get('bp_id')
                            },
                            success: function(res) {
                                var fin_statement_templet_id = res.result.record['fin_statement_templet_id'];
                                var fin_count = res.result.record['fin_count'];
                                if (fin_count == 0) {
                                    if (name == 'psr_change_info_link') {
                                        show_message = '该承租人财务变化率明细信息不存在！';
                                    } else if (name == 'gua_psr_change_info_link') {
                                        show_message = '该担保人财务变化率明细信息不存在！';
                                    }
                                } else {
                                    url = '${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_change_rate.screen?fin_statement_templet_id=' + fin_statement_templet_id + '&amp;bp_id=' + record.get('bp_id');
                                    url_title = '${l:RSC_FIN_STATEMENT_TMPLT_HDS.CHANGERATE_DETAIL}';
                                }
                            },
                            sync: true
                        });
                    } else if (name == 'bp_statement_note') {
                        var bp_id = record.get('bp_id');
                        if (bp_id) {
                            url = '${/request/@context_path}/modules/prj/PRJ509/prj_project_statement_note.screen';
                            url_title = '财务报表附注';
                        }
                    }
                    if (url) {
                        parent.open_render_window(record.get('bp_seq') + '${/parameter/@layout_code}${/parameter/@tree_code}' + name + '_form_render_winid', ({
                            bp_id: record.get('bp_id'),
                            winid: record.get('bp_seq') + '${/parameter/@layout_code}${/parameter/@tree_code}' + name + '_form_render_winid'
                        }), url, url_title);
                    } else if (open_win_flag == 'Y') {
                        var param = {};
                        param['function_code'] = 'HLS306';
                        param['function_usage'] = 'QUERY';
                        param['url_title'] = '${l:HLS212.BP_MASTER_QUERY}';
                        param['master_type'] = 'BP_MASTER';
                        param['master_id'] = record.get('bp_id');
                        param['bp_class'] = record.get('bp_class');
                        prj_doc_get_layout_code('${/parameter/@layout_code}${/parameter/@tree_code}_hls_bp_master_get_layout_code_link_id', param, '${/parameter/@layout_code}${/parameter/@tree_code}_hls_bp_master_dynamic_update_link_id');
            
                    } else if (show_message) {
                        Aurora.SideBar.show({
                            duration: 2000,
                            html: '<div class="item-slideBar" style="width:200px"><div class="inner">' + show_message + '</div></div>'
                        });
                    }
                } else {
                    Aurora.showMessage('${l:PROMPT}', '${l:PRJ501.PLEASE_MODIFY_BP_INFORMATION}');
                    return;
                }
            };
            
            window['${/parameter/@layout_code}_prj500_cdd_attachtment_upload'] = function(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('check_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_prj500_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    } else {
                        url = $('${/parameter/@layout_code}${/parameter/@tree_code}_prj500_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_prj500_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
            
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            
            function lock_current_window() {
                parent.Aurora.Masker.mask(parent.$('${/parameter/@winid}').wrap, '${l:HLS.EXECUTING}');
            }
            
            function unlock_current_window() {
                parent.Aurora.Masker.unmask(parent.$('${/parameter/@winid}').wrap);
            }
            
            window['${/parameter/@layout_code}_prj500_quote'] = function(id, name, config_record) {
            
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                var head_record = $(record.ds.bindtarget).getAt(0),
                    url;
                if ('${/parameter/@calc_type}' == 'LITE_CALCULATOR') {
                    url = $('${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calc_quotation_header_link_id').getUrl();
                } else if ('${/parameter/@calc_type}' == 'CLASSIC_CALCULATOR') {
                    url = $('${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calculator_update_link_id').getUrl();
                } else {
                    Aurora.showMessage('${l:PROMPT}', '${l:HLS.CALC_TYPE_IS_NULL}');
                    return;
                }
            
                if ($(record.ds.id).validate()) {
                    if (!record.get('price_list') || !record.get('currency') || !record.get('lease_times')) {
                        Aurora.showMessage('${l:PROMPT}', '${l:HLS.QUOTATION_EXECUTE_AFTER_SAVE}');
                        return;
                    }
                    lock_current_window();
                    var parent_pk_value = head_record.get('project_id');
                    record.set('function_code', '${/parameter/@function_code}');
                    record.set('function_usage', '${/parameter/@function_usage}');
                    record.set('project_id', parent_pk_value);
                    record.set('to_doc_table', 'HLS_FIN_CALCULATOR_HD');
                    record.set('from_doc_table', 'PRJ_QUOTATION');
                    record.set('from_doc_pk', record.get('quotation_id'));
                    record.set('calculate_flag', 'N');
                    var calc_recreate_L_formula;
                    if (record.get('quotation_id') && !record.get('calc_session_id')) {
                        calc_recreate_L_formula = 'Y';
                        record.set('_status', 'update');
                    } else if (record.get('quotation_id') && record.get('calc_session_id')) {
                        calc_recreate_L_formula = 'N';
                        record.set('_status', 'execute');
                    } else {
                        calc_recreate_L_formula = 'Y';
                        record.set('_status', 'insert');
                    }
                    var saveData = [];
                    saveData.push(record.data);
            
                    Aurora.request({
                        url: $('${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_doc_quotation_link_id').getUrl(),
                        para: saveData,
                        success: function(res) {
                            unlock_current_window();
                            $(record.ds.id).query();
                            var quotation_id = record.get('quotation_id') || res.result.quotation_id;
                            parent.open_render_window('${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calc_quotation_header_link_winid', ({
                                document_id: parent_pk_value,
                                document_category: '${/parameter/@document_category}',
                                maintain_type: '${/parameter/@maintain_type}',
                                calc_session_id: res.result.record.calc_session_id,
                                quotation_id: quotation_id,
                                dsId: record.ds.id,
                                winId: '${/parameter/@layout_code}${/parameter/@tree_code}_hls_fin_calc_quotation_header_link_winid',
                                global_flag: 'Y',
                                id_num: 0,
                                calc_type: '${/parameter/@calc_type}',
                                recreate_L_formula: calc_recreate_L_formula
                            }), url, '');
                        },
                        failure: function() {
                            unlock_current_window();
                        },
                        error: function() {
                            unlock_current_window();
                        },
                        scope: this
                    });
                }
            };
            
            //租赁物导入
            window['${/parameter/@layout_code}_G_LEASE_ITEM_USER_BUTTON1_layout_dynamic_tab_click'] = function() {
                var project_id = '${/parameter/@document_id}';
                if (!Ext.isEmpty(project_id)) {
                    new Aurora.Window({
                        id: 'prj_project_lease_item_import_handle_win',
                        url: '${/request/@context_path}/modules/prj/PRJ500/prj_project_lease_item_import_handle.screen',
                        params: {
                            'winid': 'prj_project_lease_item_import_handle_win',
                            'project_id': project_id,
                            'session_id': '${/session/@session_id}',
                            'parent_ds_id': '${/parameter/@layout_code}_G_LEASE_ITEM_prj_project_lease_item_ds'
                        },
                        width: 500,
                        height: 400
                    });
                }
            
            };
            
            //抵质押物新增
            window['${/parameter/@layout_code}_F_MORTGAGE_01_MO_ADD_layout_dynamic_tab_click'] = function() {
                var form_ds = $('${/parameter/@layout_code}_F_MORTGAGE_01_prj_project_mortgage_ds');
                form_ds.removeAll();
                var record = form_ds.create();
                record.set('project_id', '${/parameter/@document_id}');
            };
            
            //抵质押物保存
            window['${/parameter/@layout_code}_F_MORTGAGE_01_MO_SAVE_layout_dynamic_tab_click'] = function() {
                lock_current_window();
                var form_ds = $('${/parameter/@layout_code}_F_MORTGAGE_01_prj_project_mortgage_ds');
                if (form_ds.validate()) {
                    form_ds.submit();
                    form_ds.on('submitsuccess', function(ds) {
                        var ref_grid_ds = $('${/parameter/@layout_code}_G_MORTGAGE_prj_project_mortgage_ds');
                        ref_grid_ds.query();
                        unlock_current_window();
                    });
                } else {
                    unlock_current_window();
                }
            };
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
