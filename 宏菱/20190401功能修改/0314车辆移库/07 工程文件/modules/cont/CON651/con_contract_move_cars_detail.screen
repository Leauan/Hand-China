<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:view>
        <a:link id="con_contract_move_cars_select_link" url="${/request/@context_path}/modules/cont/CON651/con_contract_move_cars_select.screen"/>
        <a:link id="con_contract_move_cars_cancel_link" model="cont.CON651.update_agent_id_and_other" modelaction="update"/>
        <a:link id="con_move_cars_submit_wfl_link" model="cont.CON651.con_move_cars_submit_wfl" modelaction="execute"/>
        <script><![CDATA[
            // 提交审批
            window['${/parameter/@layout_code}_submit_approval_layout_dynamic_click'] = function() {
                var hd_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_move_cars_hd');
                var record = $(hd_ds).getAt(0);
                var ln_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_move_cars_ln');
                var records = $(ln_ds).getAll();
                for (var i = 0;i < records.length;i++) {
                    var record_d = records[i];
                    if (record_d.dirty || !record.get('note') || !record_d.get('after_id') || !record_d.get('move_date') || !record_d.get('phone') || !record_d.get('contact_person')) {
                        var check_save =true;
                    }
                }
                if(check_save){
                    Aurora.showInfoMessage('提示', '请先保存！');
                    return false;
                }
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认提交申请？', function() {
                    Aurora.Masker.mask(Ext.getBody());
                    Aurora.request({
                        url: $('con_move_cars_submit_wfl_link').getUrl(),
                        para: {
                            hd_id: record.get('hd_id')
                        },
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
                            $('${/parameter/@winid}').close();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }, null);
            };
            // 取消申请按钮
            window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                var hd_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_move_cars_hd');
                //var ln_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_move_cars_ln');
                var hd_record = $(hd_ds).getAt(0);
                //var ln_record = $(ln_ds).getAll();
                Aurora.showConfirm('${l:HLS.PROMPT}', '确认取消申请？', function() {
                    Aurora.Masker.mask(Ext.getBody());
                    Aurora.request({
                        url: $('con_contract_move_cars_cancel_link').getUrl(),
                        para: {
                            hd_id: hd_record.get('hd_id')
                        },
                        success: function(res) {
                            Aurora.Masker.unmask(Ext.getBody());
                            $('${/parameter/@winid}').close();
                        },
                        failure: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function() {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        scope: this
                    });
                }, null);
            };
           //批量录入库点信息并确认
           window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
               var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_move_cars_ln');
               var records = $(ds_id).getSelected();
               if (records.length < 1) {
                   Aurora.showInfoMessage('', '请选择一条', null, 250, 100);
                   return;
               }
               var param = {};
               var win = new Aurora.Window({
                   id: 'con_contract_move_cars_select_winid',
                   url: $('con_contract_move_cars_select_link').getUrl(),
                   params: {
                       winId: 'con_contract_move_cars_select_winid',
                       pre_layout_code: '${/parameter/@layout_code}',
                       pre_function_code: '${/parameter/@function_code}',
                       function_code: 'CON651R',
                       function_usage: 'CREATE'
                   },
                   title: '选择移库',
                   width: 410,
                   height: 260
               });
               win.on('close',function(){
                   $(ds_id).query();
               });
           };

           // 更新事件
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
                if(name == 'inventory_address_level' && value){
                    if(value == 'EXHIBITION'){
                        record.getField('remove_date').setRequired(true);
                    }else{
                        record.getField('remove_date').setRequired(false);
                    }
                }

            };

         
       ]]></script>
        <!-- <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/> -->
    </a:view>
</a:screen>
